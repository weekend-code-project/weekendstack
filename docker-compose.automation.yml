# =============================================================================
# AUTOMATION SERVICES - HOME AUTOMATION AND IOT
# =============================================================================
# This file contains home automation services:
# - Home Assistant: Smart home automation platform
#
# Usage:
#   docker compose --profile automation up -d
#
# Data Storage:
#   Configuration and state stored under ./files/homeassistant/
# =============================================================================

networks:
  automation-network:
    name: automation-network
    driver: bridge
    external: false

services:
  # =============================================================================
  # HOME ASSISTANT PERMISSIONS INIT
  # =============================================================================
  # One-shot container to ensure the bind-mounted /config is owned by the same
  # UID/GID that Home Assistant runs as. This avoids root-owned files (e.g.
  # /config/.storage/auth) that can prevent Home Assistant from starting.
  #
  # This keeps the stack self-contained: no host sudo/manual chown needed.
  # =============================================================================
  homeassistant-perms:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant-perms
    user: "0:0"
    networks:
      - automation-network
    profiles:
      - all
      - automation
    volumes:
      - type: bind
        source: ${FILES_BASE_DIR:-./files}/homeassistant/config
        target: /config
        bind:
          create_host_path: true
    entrypoint:
      - sh
      - -lc
      - |
        chown -R "${HOMEASSISTANT_UID:-1000}:${HOMEASSISTANT_GID:-1000}" /config
    restart: "no"

  # =============================================================================
  # HOME ASSISTANT - SMART HOME AUTOMATION PLATFORM
  # =============================================================================
  # Home Assistant is a powerful home automation platform that puts local control
  # and privacy first. It integrates with thousands of devices and services.
  #
  # First Run:
  #   1. Access http://<your-ip>:8123
  #   2. Create your admin account
  #   3. Set up your home location and preferences
  #
  # Device Discovery:
  #   For full device discovery (mDNS, SSDP, etc.), you may need to use
  #   network_mode: host instead of bridge networking. See comments below.
  # =============================================================================
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    user: "${HOMEASSISTANT_UID:-1000}:${HOMEASSISTANT_GID:-1000}"
    restart: unless-stopped
    networks:
      - automation-network
      - shared-network
    depends_on:
      homeassistant-perms:
        condition: service_completed_successfully
    profiles:
      - all
      - automation
    ports:
      - "${HOMEASSISTANT_PORT:-8123}:8123"
    environment:
      TZ: ${TIMEZONE:-UTC}
    volumes:
      - type: bind
        source: ${FILES_BASE_DIR:-./files}/homeassistant/config
        target: /config
        bind:
          create_host_path: true
      - /etc/localtime:/etc/localtime:ro
    # Uncomment the following for USB device access (Zigbee/Z-Wave dongles)
    # privileged: true
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0  # Zigbee/Z-Wave USB stick
    #   - /dev/ttyACM0:/dev/ttyACM0  # Alternative USB device path
    deploy:
      resources:
        limits:
          memory: ${HOMEASSISTANT_MEMORY_LIMIT:-2g}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - traefik.enable=${HOMEASSISTANT_TRAEFIK_ENABLE:-true}
      - "traefik.http.routers.homeassistant.rule=Host(`homeassistant.${BASE_DOMAIN}`)"
      - traefik.http.routers.homeassistant.entrypoints=websecure
      - traefik.http.routers.homeassistant.tls=true
      - "traefik.http.routers.homeassistant-http.rule=Host(`homeassistant.lab`)"
      - traefik.http.routers.homeassistant-http.entrypoints=web
      - traefik.http.services.homeassistant.loadbalancer.server.port=8123
      - traefik.docker.network=shared-network
      - "com.docker.compose.service=homeassistant"
      - "description=Home Assistant - Smart Home Automation"

  # =============================================================================
  # NODE-RED - Flow-Based Automation
  # =============================================================================
  # A programming tool for wiring together hardware devices, APIs and online services.
  # Uses a browser-based flow editor with a wide range of nodes.
  # =============================================================================
  nodered:
    image: nodered/node-red:latest
    container_name: nodered
    networks:
      - automation-network
      - shared-network
    profiles:
      - all
      - automation
    ports:
      - "${NODERED_PORT:-1880}:1880"
    environment:
      TZ: ${TIMEZONE:-UTC}
    volumes:
      - type: volume
        source: nodered-data
        target: /data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${NODERED_MEMORY_LIMIT:-512m}
    labels:
      - traefik.enable=true
      - traefik.http.routers.nodered.rule=Host(`nodered.${BASE_DOMAIN}`)
      - traefik.http.routers.nodered.entrypoints=websecure
      - traefik.http.routers.nodered.tls=true
      - traefik.http.routers.nodered-http.rule=Host(`nodered.lab`)
      - traefik.http.routers.nodered-http.entrypoints=web
      - traefik.http.services.nodered.loadbalancer.server.port=1880
      - traefik.docker.network=shared-network

volumes:
  nodered-data:
