# =============================================================================
# MONITORING & INFRASTRUCTURE STACK
# =============================================================================
# Services for monitoring, logging, backups, and infrastructure management
#
# Included services:
# - Dozzle: Real-time Docker log viewer
# - Watchtower: Automatic container updates
# - Uptime Kuma: Service uptime monitoring
# - Netdata: Real-time system monitoring
# - Netbox: Network documentation/IPAM
# - Duplicati: Backup solution
# - Komodo: Container management
#
# Usage: docker compose -f docker-compose.monitoring.yml --profile monitoring up -d
# =============================================================================

networks:
  monitoring-network:
    name: monitoring-network
    driver: bridge

volumes:
  uptime-kuma-data:
  netdata-config:
  netdata-lib:
  netdata-cache:
  netbox-data:
  netbox-redis:
  netbox-postgres:
  duplicati-config:
  duplicati-backups:
  portainer-data:
  speedtest-data:

services:
  # =============================================================================
  # COCKPIT - Server Management UI (local-only)
  # =============================================================================
  # Cockpit runs as a web service and typically connects to managed hosts via SSH.
  # This deployment is intentionally LAN-only (cockpit.lab) and not exposed via tunnel.
  #
  # Notes:
  # - From the Cockpit login page, connect to your host via SSH (e.g. host.docker.internal)
  # - This container maps host.docker.internal -> host-gateway for Linux.
  # =============================================================================
  cockpit:
    image: quay.io/cockpit/ws:latest
    container_name: cockpit
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Run cockpit-ws directly (the image's default CMD is a wrapper).
    entrypoint: ["/container/label-run"]
    command: ["--no-tls", "--port", "9090"]
    deploy:
      resources:
        limits:
          memory: ${COCKPIT_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=cockpit
      - glance.group=Monitoring
      - glance.name=Cockpit
      - glance.icon=si:cockpit
      - glance.url=/go/cockpit
      - glance.description=Server Management
      - glance.hide=true
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.cockpit-http.rule=Host(`cockpit.lab`)
      - traefik.http.routers.cockpit-http.entrypoints=web
      - traefik.http.services.cockpit.loadbalancer.server.port=9090
      - traefik.docker.network=shared-network

  # =============================================================================
  # DOZZLE - Real-time Docker Log Viewer
  # =============================================================================
  # Lightweight, web-based Docker log viewer. No database required.
  # =============================================================================
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${DOZZLE_PORT:-9999}:8080"
    environment:
      DOZZLE_LEVEL: info
      DOZZLE_TAILSIZE: 300
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128m
    labels:
      # Glance Configuration
      - glance.id=dozzle
      - glance.group=Monitoring
      - glance.name=Dozzle
      - glance.icon=si:logstash
      - glance.url=/go/dozzle
      - glance.description=Log Viewer
      - glance.hide=true
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.dozzle-http.rule=Host(`dozzle.lab`)
      - traefik.http.routers.dozzle-http.entrypoints=web
      - traefik.http.services.dozzle.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

  # =============================================================================
  # WHAT'S UP DOCKER (WUD) - Container Update Manager
  # =============================================================================
  # Shows available updates for running containers with a web dashboard.
  # Does NOT auto-update by default - you review and trigger updates manually.
  # Authentication: Built-in basic auth + Traefik middleware for public access
  # Default: admin / wud-admin-2024
  # =============================================================================
  wud:
    image: fmartinou/whats-up-docker:latest
    container_name: wud
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${WUD_PORT:-3002}:3000"
    environment:
      - WUD_TRIGGER_DOCKERHUB_ENABLE=false
      - WUD_WATCHER_LOCAL_CRON=0 0 * * *
      - WUD_WATCHER_LOCAL_WATCHBYDEFAULT=true
      # Built-in basic auth - Default: admin / admin
      # Generate hash: docker run --rm httpd:2-alpine htpasswd -nbm USER PASS
      # Copy hash part (after colon) to WUD_AUTH_HASH in .env (wrap in single quotes)
      - WUD_AUTH_BASIC_MYAUTH_USER=${WUD_AUTH_USER:-admin}
      - WUD_AUTH_BASIC_MYAUTH_HASH=${WUD_AUTH_HASH:-}
      - TZ=${TZ:-America/New_York}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${WUD_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=wud
      - glance.group=Monitoring
      - glance.name=What's Up Docker
      - glance.icon=si:docker
      - glance.url=/go/wud
      - glance.description=Update Manager      - glance.hide=true      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.wud-http.rule=Host(`wud.lab`)
      - traefik.http.routers.wud-http.entrypoints=web
      - traefik.http.services.wud.loadbalancer.server.port=3000
      - traefik.docker.network=shared-network

  # =============================================================================
  # SPEEDTEST TRACKER - Internet Speed Monitor
  # =============================================================================
  # Tracks your internet speed over time with scheduled tests
  # Default: Tests run every hour, stores historical data
  # =============================================================================
  # =============================================================================
  # SPEEDTEST TRACKER - Internet Speed Monitoring
  # =============================================================================
  # Web UI with scheduled tests and API for Glance widget
  # Requires one-time setup: http://192.168.2.50:8765/admin/login
  # Default: admin@example.com / password
  # =============================================================================
  speedtest-tracker:
    image: lscr.io/linuxserver/speedtest-tracker:latest
    container_name: speedtest-tracker
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${SPEEDTEST_PORT:-8765}:80"
    environment:
      PUID: 1000
      PGID: 1000
      TZ: ${TZ:-America/New_York}
      DB_CONNECTION: sqlite
      APP_KEY: base64:02KsGT9QvDav6HUStRvjqDjUqFKa96RDS7SibKfZ1VI=
      APP_URL: http://${HOST_IP}:${SPEEDTEST_PORT:-8765}
      SPEEDTEST_SCHEDULE: ${SPEEDTEST_SCHEDULE:-0 * * * *}
    volumes:
      - speedtest-data:/config
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${SPEEDTEST_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=speedtest
      - glance.group=Monitoring
      - glance.name=Speedtest Tracker
      - glance.icon=si:speedtest
      - glance.url=/go/speedtest
      - glance.description=Internet Speed Monitor
      - glance.hide=true
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.speedtest-http.rule=Host(`speedtest.lab`)
      - traefik.http.routers.speedtest-http.entrypoints=web
      - traefik.http.services.speedtest.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

  # =============================================================================
  # UPTIME KUMA - Service Monitoring
  # =============================================================================
  # Self-hosted monitoring tool like "Uptime Robot"
  # =============================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${UPTIME_KUMA_PORT:-3001}:3001"
    volumes:
      - type: volume
        source: uptime-kuma-data
        target: /app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m
    labels:
      # Glance Configuration
      - glance.id=uptime-kuma
      - glance.group=Monitoring
      - glance.name=Uptime Kuma
      - glance.icon=si:statuspage
      - glance.url=/go/uptime-kuma
      - glance.description=Uptime Monitoring
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.uptime-kuma-http.rule=Host(`uptime-kuma.lab`)
      - traefik.http.routers.uptime-kuma-http.entrypoints=web
      - traefik.http.services.uptime-kuma.loadbalancer.server.port=3001
      - traefik.docker.network=shared-network

  # =============================================================================
  # NETDATA - Real-time System Monitoring
  # =============================================================================
  # High-resolution system monitoring with beautiful dashboards
  # =============================================================================
  netdata:
    image: netdata/netdata:stable
    container_name: netdata
    hostname: ${HOSTNAME:-docker-host}
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${NETDATA_PORT:-19999}:19999"
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    environment:
      NETDATA_CLAIM_TOKEN: ${NETDATA_CLAIM_TOKEN:-}
      NETDATA_CLAIM_URL: ${NETDATA_CLAIM_URL:-https://app.netdata.cloud}
      NETDATA_CLAIM_ROOMS: ${NETDATA_CLAIM_ROOMS:-}
    volumes:
      - type: volume
        source: netdata-config
        target: /etc/netdata
      - type: volume
        source: netdata-lib
        target: /var/lib/netdata
      - type: volume
        source: netdata-cache
        target: /var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
    labels:
      # Glance Configuration
      - glance.id=netdata
      - glance.group=Monitoring
      - glance.name=Netdata
      - glance.icon=si:netdata
      - glance.url=/go/netdata
      - glance.description=System Monitoring
      - glance.hide=true
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.netdata-http.rule=Host(`netdata.lab`)
      - traefik.http.routers.netdata-http.entrypoints=web
      - traefik.http.services.netdata.loadbalancer.server.port=19999
      - traefik.docker.network=shared-network

  # =============================================================================
  # DUPLICATI - Backup Solution
  # =============================================================================
  # Free backup software to store encrypted backups online
  # =============================================================================
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${DUPLICATI_PORT:-8200}:8200"
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      SETTINGS_ENCRYPTION_KEY: ${DUPLICATI_ENCRYPTION_KEY:-duplicati-encryption-key-change-me}
    volumes:
      - type: volume
        source: duplicati-config
        target: /config
      - type: volume
        source: duplicati-backups
        target: /backups
      - /opt/stacks:/source/stacks:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
    labels:
      # Glance Configuration
      - glance.id=duplicati
      - glance.group=Monitoring
      - glance.name=Duplicati
      - glance.icon=si:duplicati
      - glance.url=/go/duplicati
      - glance.description=Backup Solution
      - glance.hide=true
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.duplicati-http.rule=Host(`duplicati.lab`)
      - traefik.http.routers.duplicati-http.entrypoints=web
      - traefik.http.services.duplicati.loadbalancer.server.port=8200
      - traefik.docker.network=shared-network

  # =============================================================================
  # PORTAINER - Container Management UI
  # =============================================================================
  # Easy-to-use Docker container management interface
  # =============================================================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${PORTAINER_PORT:-9443}:9443"
      - "9000:9000"
    volumes:
      - type: volume
        source: portainer-data
        target: /data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m
    labels:
      # Glance Configuration
      - glance.id=portainer
      - glance.group=Monitoring
      - glance.name=Portainer
      - glance.icon=si:portainer
      - glance.url=/go/portainer
      - glance.description=Container Management
      - glance.hide=true
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.portainer-http.rule=Host(`portainer.lab`)
      - traefik.http.routers.portainer-http.entrypoints=web
      - traefik.http.services.portainer.loadbalancer.server.port=9000
      - traefik.docker.network=shared-network

  # =============================================================================
  # NETBOX - Network Documentation & IPAM
  # =============================================================================
  # IP address management (IPAM) and data center infrastructure management (DCIM)
  # =============================================================================
  netbox:
    image: netboxcommunity/netbox:latest
    container_name: netbox
    networks:
      - monitoring-network
      - shared-network
    profiles:
      - all
      - monitoring
    ports:
      - "${NETBOX_PORT:-8484}:8080"
    environment:
      SUPERUSER_NAME: ${NETBOX_SUPERUSER:-admin}
      SUPERUSER_EMAIL: ${NETBOX_SUPERUSER_EMAIL:-admin@example.com}
      SUPERUSER_PASSWORD: ${NETBOX_SUPERUSER_PASSWORD:-admin}
      ALLOWED_HOSTS: "*"
      DB_HOST: netbox-postgres
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: ${NETBOX_DB_PASSWORD:-netbox}
      REDIS_HOST: netbox-redis
      REDIS_PASSWORD: ""
      SECRET_KEY: ${NETBOX_SECRET_KEY:-netbox-secret-key-change-me-in-production}
      SKIP_SUPERUSER: "false"
    volumes:
      - type: volume
        source: netbox-data
        target: /opt/netbox/netbox/media
    depends_on:
      - netbox-postgres
      - netbox-redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
    labels:
      # Glance Configuration
      - glance.id=netbox
      - glance.group=Monitoring
      - glance.name=NetBox
      - glance.icon=si:cilium
      - glance.url=/go/netbox
      - glance.description=IPAM & DCIM
      - glance.hide=true
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.netbox-http.rule=Host(`netbox.lab`)
      - traefik.http.routers.netbox-http.entrypoints=web
      - traefik.http.services.netbox.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

  netbox-postgres:
    image: postgres:15-alpine
    container_name: netbox-postgres
    labels:
      - glance.parent=netbox
      - glance.name=Database
    networks:
      - monitoring-network
    profiles:
      - all
      - monitoring
    environment:
      POSTGRES_DB: netbox
      POSTGRES_USER: netbox
      POSTGRES_PASSWORD: ${NETBOX_DB_PASSWORD:-netbox}
    volumes:
      - type: volume
        source: netbox-postgres
        target: /var/lib/postgresql/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m

  netbox-redis:
    image: redis:7-alpine
    container_name: netbox-redis
    labels:
      - glance.parent=netbox
      - glance.name=Redis
    networks:
      - monitoring-network
    profiles:
      - all
      - monitoring
    volumes:
      - type: volume
        source: netbox-redis
        target: /data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64m
