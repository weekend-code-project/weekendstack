# =============================================================================
# CORE AI DEV STACK - BASE CONFIGURATION  
# =============================================================================
# This file contains the essential foundation services
#
# Core services:
# - Glance: Dashboard / Start Page
# - Dozzle: Real-time log viewer (essential troubleshooting)
# - Speedtest Tracker: Internet speed monitoring
#
# Additional development services are defined in separate compose files
#
# Usage:
#   docker compose --profile core up -d
# =============================================================================

networks:
  core-network:
    name: core-network
    driver: bridge
    external: false

# Global volumes for database storage (managed by Docker)
volumes:
  # Core service databases
  coder-db-data:
  gitea-db-data:
  speedtest-data:

services:
  # =============================================================================
  # GLANCE - DASHBOARD / START PAGE
  # =============================================================================
  # YAML-configured dashboard with widgets (RSS, monitoring, docker status, etc.)
  # Config: ./config/glance/glance.yml
  # Local: http://home.lab (Traefik) or http://192.168.2.50:8080
  # =============================================================================
  glance:
    image: glanceapp/glance:latest
    container_name: glance
    restart: unless-stopped
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    # Port removed - access via Traefik on port 80 instead
    # Emergency fallback: uncomment to enable direct access on port 8080
    # ports:
    #   - "${HOST_IP:-192.168.2.50}:${GLANCE_PORT:-8080}:8080"
    environment:
      HOST_IP: ${HOST_IP:-192.168.2.50}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
      CLOUDFLARE_TUNNEL_ID: ${CLOUDFLARE_TUNNEL_ID}
      CLOUDFLARE_API_KEY: ${CLOUDFLARE_API_KEY}
      IMMICH_URL: ${IMMICH_URL}
      IMMICH_API_KEY: ${IMMICH_API_KEY}
      PAPERLESS_URL: ${PAPERLESS_URL}
      PAPERLESS_API_KEY: ${PAPERLESS_API_KEY}
      SPEEDTEST_URL: ${SPEEDTEST_URL}
      SPEEDTEST_TRACKER_API_TOKEN: ${SPEEDTEST_TRACKER_API_TOKEN}
      WUD_URL: ${WUD_URL}
      WUD_AUTH_USER: ${WUD_AUTH_USER:-admin}
      WUD_AUTH_PASSWORD: ${WUD_AUTH_PASSWORD:-admin}
    volumes:
      - type: bind
        source: ./config/glance/glance.yml
        target: /app/config/glance.yml
        read_only: true
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      resources:
        limits:
          memory: ${GLANCE_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=glance
      - glance.group=Core
      - glance.name=Glance Dashboard
      - glance.icon=si:homeassistant
      - glance.url=/go/home
      - glance.description=Dashboard
      - glance.hide=true
      
      # Traefik Configuration
      - traefik.enable=true
      
      # External domain - redirect root to /external (highest priority, no auth)
      - traefik.http.routers.glance-external-root.entrypoints=websecure
      - "traefik.http.routers.glance-external-root.rule=Host(`home.${BASE_DOMAIN}`) && Path(`/`)"
      - traefik.http.routers.glance-external-root.tls=true
      - traefik.http.routers.glance-external-root.service=glance
      - traefik.http.routers.glance-external-root.priority=150
      - traefik.http.routers.glance-external-root.middlewares=glance-external-redirect@file
      
      # External domain (HTTPS via Cloudflare) - Requires auth for all other paths
      - traefik.http.routers.glance-external.entrypoints=websecure
      - "traefik.http.routers.glance-external.rule=Host(`home.${BASE_DOMAIN}`) && !PathPrefix(`/go/`)"
      - traefik.http.routers.glance-external.tls=true
      - traefik.http.routers.glance-external.service=glance
      - traefik.http.routers.glance-external.priority=100
      - traefik.http.routers.glance-external.middlewares=it-tools-auth@file
      
      # HTTP router with redirect
      - traefik.http.routers.glance-http.entrypoints=web
      - "traefik.http.routers.glance-http.rule=(Host(`home.${LAB_DOMAIN}`) || Host(`${HOST_IP}`)) && !PathPrefix(`/go/`)"
      - traefik.http.routers.glance-http.priority=100
      - traefik.http.routers.glance-http.middlewares=redirect-to-https@file
      - traefik.http.routers.glance-http.service=glance
      
      # HTTPS router - Local .lab (No auth for trusted network)
      - traefik.http.routers.glance.entrypoints=websecure
      - "traefik.http.routers.glance.rule=(Host(`home.${LAB_DOMAIN}`) || Host(`${HOST_IP}`)) && !PathPrefix(`/go/`)"
      - traefik.http.routers.glance.priority=100
      - traefik.http.routers.glance.service=glance
      - traefik.http.routers.glance.tls=true
      
      # Service definition
      - traefik.http.services.glance.loadbalancer.server.port=8080
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}

      - "com.docker.compose.service=glance"
      - "description=Glance - Dashboard / Start Page"

  # =============================================================================
  # DOZZLE - Real-time Docker Log Viewer
  # =============================================================================
  # Lightweight, web-based Docker log viewer. No database required.
  # Essential for troubleshooting services
  # =============================================================================
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    ports:
      - "${DOZZLE_PORT:-9999}:8080"
    environment:
      DOZZLE_LEVEL: info
      DOZZLE_TAILSIZE: 300
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128m
    labels:
      # Glance Configuration
      - glance.id=dozzle
      - glance.group=Core
      - glance.name=Dozzle
      - glance.icon=si:logstash
      - glance.url=/go/dozzle
      - glance.description=Log Viewer
      
      # Traefik Configuration
      - traefik.enable=true
      
      # Local .lab domain (HTTP)
      - traefik.http.routers.dozzle-lab-http.entrypoints=web
      - traefik.http.routers.dozzle-lab-http.rule=Host(`dozzle.${LAB_DOMAIN}`)
      - traefik.http.routers.dozzle-lab-http.middlewares=redirect-to-https@file
      - traefik.http.routers.dozzle-lab-http.service=dozzle
      
      # Local .lab domain (HTTPS)
      - traefik.http.routers.dozzle-lab.entrypoints=websecure
      - traefik.http.routers.dozzle-lab.rule=Host(`dozzle.${LAB_DOMAIN}`)
      - traefik.http.routers.dozzle-lab.tls=true
      - traefik.http.routers.dozzle-lab.service=dozzle
      
      # Service definition
      - traefik.http.services.dozzle.loadbalancer.server.port=8080
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}

  # =============================================================================
  # SPEEDTEST TRACKER - Internet Speed Monitor  
  # =============================================================================
  # Web UI with scheduled tests and API for Glance widget
  # Essential for monitoring network performance
  # Requires one-time setup: http://speedtest.lab
  # Default: admin@example.com / password
  # =============================================================================
  speedtest-tracker:
    image: lscr.io/linuxserver/speedtest-tracker:latest
    container_name: speedtest-tracker
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    ports:
      - "${SPEEDTEST_PORT:-8765}:80"
    environment:
      PUID: 1000
      PGID: 1000
      TZ: ${TZ:-America/New_York}
      DB_CONNECTION: sqlite
      APP_KEY: base64:02KsGT9QvDav6HUStRvjqDjUqFKa96RDS7SibKfZ1VI=
      APP_URL: http://${HOST_IP}:${SPEEDTEST_PORT:-8765}
      SPEEDTEST_SCHEDULE: ${SPEEDTEST_SCHEDULE:-0 * * * *}
    volumes:
      - speedtest-data:/config
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${SPEEDTEST_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=speedtest
      - glance.group=Core
      - glance.name=Speedtest Tracker
      - glance.icon=si:speedtest
      - glance.url=/go/speedtest
      - glance.description=Internet Speed Monitor
      
      # Traefik Configuration
      - traefik.enable=true
      
      # Local .lab domain (HTTP)
      - traefik.http.routers.speedtest-lab-http.entrypoints=web
      - traefik.http.routers.speedtest-lab-http.rule=Host(`speedtest.${LAB_DOMAIN}`)
      - traefik.http.routers.speedtest-lab-http.middlewares=redirect-to-https@file
      - traefik.http.routers.speedtest-lab-http.service=speedtest
      
      # Local .lab domain (HTTPS)
      - traefik.http.routers.speedtest-lab.entrypoints=websecure
      - traefik.http.routers.speedtest-lab.rule=Host(`speedtest.${LAB_DOMAIN}`)
      - traefik.http.routers.speedtest-lab.tls=true
      - traefik.http.routers.speedtest-lab.service=speedtest
      
      # Service definition
      - traefik.http.services.speedtest.loadbalancer.server.port=80
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}
