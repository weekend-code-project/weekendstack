# =============================================================================
# NETWORKING SERVICES - REVERSE PROXY, TUNNELS, AND DNS
# =============================================================================
# This file contains networking infrastructure services:
# - Traefik: Reverse proxy and load balancer
# - Cloudflare Tunnel: Secure external access
# - Pi-Hole: Network-wide ad blocking and DNS (internal only)
# - Cert Generator: Automatic local HTTPS certificate generation
#
# Usage:
#   docker compose --profile networking up -d
#   docker compose --profile proxy up -d  (legacy alias)
# =============================================================================

services:
  # =============================================================================
  # CERT-GENERATOR - AUTOMATIC LOCAL HTTPS CERTIFICATE GENERATION
  # =============================================================================
  # Generates a local Certificate Authority (CA) and wildcard certificate for *.lab domains
  # Runs once on startup to create certificates if they don't exist
  # After first run, you need to manually trust the CA certificate (see docs/local-https-setup.md)
  # =============================================================================
  cert-generator:
    image: alpine:3.20
    container_name: cert-generator
    restart: "no"
    profiles:
      - all
      - networking
      - setup
    environment:
      LAB_DOMAIN: ${LAB_DOMAIN:-lab}
      CERT_VALID_DAYS: ${CERT_VALID_DAYS:-825}  # Chrome requirement: max 825 days
      CA_VALID_DAYS: ${CA_VALID_DAYS:-3650}     # 10 years
    volumes:
      - type: bind
        source: ./config/traefik/certs
        target: /certs
    labels:
      - glance.parent=traefik
      - glance.name=Cert Generator
    command:
      - /bin/sh
      - -c
      - |
        set -e
        
        # Install OpenSSL
        apk add --no-cache openssl
        
        cd /certs
        
        # Check if certificates already exist
        if [ -f "ca-cert.pem" ] && [ -f "ca-key.pem" ] && [ -f "cert.pem" ] && [ -f "key.pem" ]; then
          echo "âœ“ Certificates already exist, skipping generation"
          echo ""
          echo "To regenerate certificates:"
          echo "  1. Delete files in ./config/traefik/certs/"
          echo "  2. Run: docker compose up cert-generator"
          exit 0
        fi
        
        echo "=================================================="
        echo "Generating Local HTTPS Certificates for *.$$LAB_DOMAIN"
        echo "=================================================="
        echo ""
        
        # Generate CA private key
        echo "1. Generating Certificate Authority (CA) private key..."
        openssl genrsa -out ca-key.pem 4096
        
        # Generate CA certificate
        echo "2. Generating CA certificate (valid $$CA_VALID_DAYS days)..."
        openssl req -new -x509 \
          -days $$CA_VALID_DAYS \
          -key ca-key.pem \
          -out ca-cert.pem \
          -subj "/C=US/ST=Local/L=Local/O=Weekend Stack/OU=IT/CN=Weekend Stack Local CA"
        
        # Generate server private key
        echo "3. Generating server private key..."
        openssl genrsa -out key.pem 4096
        
        # Generate certificate signing request (CSR)
        echo "4. Generating certificate signing request..."
        openssl req -new \
          -key key.pem \
          -out cert.csr \
          -subj "/C=US/ST=Local/L=Local/O=Weekend Stack/OU=IT/CN=*.$$LAB_DOMAIN"
        
        # Create config for Subject Alternative Names (SAN)
        cat > san.cnf <<EOF
        [req]
        distinguished_name = req_distinguished_name
        req_extensions = v3_req
        
        [req_distinguished_name]
        
        [v3_req]
        basicConstraints = CA:FALSE
        keyUsage = nonRepudiation, digitalSignature, keyEncipherment
        subjectAltName = @alt_names
        
        [alt_names]
        DNS.1 = *.$$LAB_DOMAIN
        DNS.2 = $$LAB_DOMAIN
        EOF
        
        # Generate certificate signed by CA
        echo "5. Generating wildcard certificate (valid $$CERT_VALID_DAYS days)..."
        openssl x509 -req \
          -in cert.csr \
          -CA ca-cert.pem \
          -CAkey ca-key.pem \
          -CAcreateserial \
          -out cert.pem \
          -days $$CERT_VALID_DAYS \
          -extensions v3_req \
          -extfile san.cnf
        
        # Clean up temporary files
        rm -f cert.csr san.cnf ca-cert.srl
        
        # Set permissions
        chmod 600 ca-key.pem key.pem
        chmod 644 ca-cert.pem cert.pem
        
        echo ""
        echo "=================================================="
        echo "âœ“ Certificate Generation Complete!"
        echo "=================================================="
        echo ""
        echo "ðŸ“ Certificates saved to: ./config/traefik/certs/"
        echo ""
        echo "Files created:"
        echo "  - ca-cert.pem     : Certificate Authority (CA) certificate"
        echo "  - ca-key.pem      : CA private key (keep secure!)"
        echo "  - cert.pem        : Wildcard certificate for *.$$LAB_DOMAIN"
        echo "  - key.pem         : Server private key"
        echo ""
        echo "=================================================="
        echo "âš ï¸  IMPORTANT: Manual Step Required"
        echo "=================================================="
        echo ""
        echo "To enable HTTPS without browser warnings, you must"
        echo "trust the CA certificate on your system/browser."
        echo ""
        echo "See detailed instructions:"
        echo "  docs/local-https-setup.md"
        echo ""
        echo "Quick start (Linux):"
        echo "  sudo cp config/traefik/certs/ca-cert.pem /usr/local/share/ca-certificates/weekendstack-ca.crt"
        echo "  sudo update-ca-certificates"
        echo ""
        echo "Firefox users: Import ca-cert.pem in Firefox settings"
        echo "(Settings â†’ Privacy & Security â†’ Certificates â†’ View Certificates â†’ Authorities â†’ Import)"
        echo ""
        echo "=================================================="
        echo ""

  # =============================================================================
  # LINK ROUTER - GO-LINKS REDIRECT SERVICE
  # =============================================================================
  # Smart URL router for /go/ paths - redirects to services based on detection
  # Automatically detects if accessed from LAN (.lab) or external (tunnel domain)
  # Local: http://home.lab/go/service or http://IP/go/service
  # External: https://home.domain.com/go/service
  # =============================================================================
  link-router:
    build:
      context: ./config/link-router
    container_name: link-router
    restart: unless-stopped
    profiles:
      - all
      - networking
    environment:
      HOST_IP: ${HOST_IP:-192.168.2.50}
      LAB_DOMAIN: ${LAB_DOMAIN:-lab}
      BASE_DOMAIN: ${BASE_DOMAIN}
      LAB_SCHEME: ${LAB_SCHEME:-http}
      EXTERNAL_SCHEME: ${EXTERNAL_SCHEME:-https}
      FORCE_LINK_MODE: ${FORCE_LINK_MODE:-}
      PORT: 8080
    networks:
      - shared-network
    labels:
      # Glance Configuration
      - glance.parent=glance
      - glance.name=Link Router
      
      # Traefik Configuration
      - traefik.enable=true
      
      # External HTTPS (Tunnel / public)
      - traefik.http.routers.link-router-external.rule=(Host(`home.${BASE_DOMAIN}`) || Host(`glance.${LAB_DOMAIN:-lab}`) || Host(`glance.${BASE_DOMAIN}`)) && PathPrefix(`/go/`)
      - traefik.http.routers.link-router-external.entrypoints=websecure
      - traefik.http.routers.link-router-external.tls=${TRAEFIK_TLS_ENABLE:-true}
      - traefik.http.routers.link-router-external.priority=100
      - traefik.http.routers.link-router-external.service=link-router

      # Local .lab and IP access (HTTP with redirect)
      - "traefik.http.routers.link-router-local-http.rule=(Host(`home.${LAB_DOMAIN}`) || Host(`${HOST_IP}`)) && PathPrefix(`/go/`)"
      - traefik.http.routers.link-router-local-http.entrypoints=web
      - traefik.http.routers.link-router-local-http.priority=200
      - traefik.http.routers.link-router-local-http.middlewares=redirect-to-https@file
      - traefik.http.routers.link-router-local-http.service=link-router
      
      # Local .lab and IP access (HTTPS)
      - "traefik.http.routers.link-router-local.rule=(Host(`home.${LAB_DOMAIN}`) || Host(`${HOST_IP}`)) && PathPrefix(`/go/`)"
      - traefik.http.routers.link-router-local.entrypoints=websecure
      - traefik.http.routers.link-router-local.priority=200
      - traefik.http.routers.link-router-local.service=link-router
      - traefik.http.routers.link-router-local.tls=true

      # Service definition
      - traefik.http.services.link-router.loadbalancer.server.port=8080
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}

  # =============================================================================
  # PI-HOLE DNSMASQ INIT - GENERATE PORTABLE LOCAL DNS RULES
  # =============================================================================
  # Generates dnsmasq config files in the bind-mounted directory so new checkouts
  # only need to set HOST_IP in .env (and optionally LAN_DNS_SERVER/LAN_DOMAIN).
  #
  # - 02-custom-lab.conf: wildcard *.lab -> ${HOST_IP}
  # - 03-forward-lan-to-router.conf (optional): forward *.${LAN_DOMAIN} to LAN_DNS_SERVER
  #
  # This container exits after writing files.
  pihole-dnsmasq-init:
    image: alpine:3.20
    container_name: pihole-dnsmasq-init
    restart: "no"
    profiles:
      - all
      - networking
    environment:
      HOST_IP: ${HOST_IP}
      LAB_DOMAIN: ${LAB_DOMAIN:-lab}
      LAN_DOMAIN: ${LAN_DOMAIN:-lan}
      LAN_DNS_SERVER: ${LAN_DNS_SERVER:-}
      ENABLE_LAN_DOMAIN_FORWARDING: ${ENABLE_LAN_DOMAIN_FORWARDING:-false}
    labels:
      - glance.parent=pihole
      - glance.name=Init Container
    volumes:
      - type: bind
        source: ${CONFIG_BASE_DIR:-./config}/pihole/etc-dnsmasq.d
        target: /dnsmasq.d
        bind:
          create_host_path: true
    command:
      - /bin/sh
      - -lc
      - |
        set -eu
        if [ -z "$${HOST_IP:-}" ]; then
          echo "ERROR: HOST_IP is required for Pi-hole local DNS rules" >&2
          exit 1
        fi

        : "$${LAB_DOMAIN:=lab}"
        if ! echo "$$LAB_DOMAIN" | grep -Eq '^[A-Za-z0-9-]+$'; then
          echo "ERROR: LAB_DOMAIN must be a simple label (e.g. 'lab')" >&2
          exit 1
        fi

        mkdir -p /dnsmasq.d

        {
          echo "# Generated by pihole-dnsmasq-init (docker compose)"
          echo "# Wildcard DNS for .$${LAB_DOMAIN} domain"
          echo "# Routes all *.$${LAB_DOMAIN} domains to the Docker host running Traefik"
          echo "address=/.$${LAB_DOMAIN}/$${HOST_IP}"
        } > /dnsmasq.d/02-custom-lab.conf

        if [ "$${ENABLE_LAN_DOMAIN_FORWARDING:-false}" = "true" ]; then
          if [ -z "$${LAN_DNS_SERVER:-}" ]; then
            echo "ERROR: ENABLE_LAN_DOMAIN_FORWARDING=true but LAN_DNS_SERVER is empty" >&2
            exit 1
          fi
          : "$${LAN_DOMAIN:=lan}"
          if ! echo "$$LAN_DOMAIN" | grep -Eq '^[A-Za-z0-9-]+$'; then
            echo "ERROR: LAN_DOMAIN must be a simple label (e.g. 'lan')" >&2
            exit 1
          fi
          {
            echo "# Generated by pihole-dnsmasq-init (docker compose)"
            echo "# Forward *.$${LAN_DOMAIN} queries to your router/LAN DNS"
            echo "server=/$${LAN_DOMAIN}/$${LAN_DNS_SERVER}"
          } > /dnsmasq.d/03-forward-lan-to-router.conf
        else
          rm -f /dnsmasq.d/03-forward-lan-to-router.conf || true
        fi

        echo "Wrote dnsmasq rules to /dnsmasq.d"

  # =============================================================================
  # TRAEFIK - REVERSE PROXY
  # =============================================================================
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    profiles:
      - all
      - proxy
      - networking
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_API_PORT:-8081}:8080"  # API/Dashboard port
    volumes:
      - ${TRAEFIK_CONFIG_FILE}:/etc/traefik/traefik.yml:ro
      - ./config/traefik/auth:/config/traefik/auth:ro
      - type: bind
        source: ./config/traefik/certs
        target: /certs
        read_only: true
    networks:
      - coder-network
      - traefik-network
      - shared-network
    depends_on:
      - socat
      - cert-generator
    labels:
      # Glance Configuration
      - glance.id=traefik
      - glance.group=Networking
      - glance.name=Traefik
      - glance.icon=si:traefikproxy
      - glance.url=/go/traefik
      - glance.description=Reverse Proxy
      - glance.hide=true
      
      # Traefik Configuration
      - traefik.enable=true
      
      # HTTP router with redirect
      - traefik.http.routers.traefik-lab-http.entrypoints=web
      - traefik.http.routers.traefik-lab-http.rule=Host(`traefik.${LAB_DOMAIN}`)
      - traefik.http.routers.traefik-lab-http.middlewares=redirect-to-https@file
      - traefik.http.routers.traefik-lab-http.service=api@internal
      
      # HTTPS router for .lab domain - Traefik dashboard
      - traefik.http.routers.traefik-lab.entrypoints=websecure
      - traefik.http.routers.traefik-lab.rule=Host(`traefik.${LAB_DOMAIN}`)
      - traefik.http.routers.traefik-lab.tls=true
      - traefik.http.routers.traefik-lab.service=api@internal
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.endpoint=tcp://socat:2375
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

  # =============================================================================
  # CLOUDFLARE TUNNEL - SECURE EXTERNAL ACCESS
  # =============================================================================
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    labels:
      - glance.hide=true
    restart: unless-stopped
    networks:
      - traefik-network
      - shared-network
    profiles:
      - proxy
      - external
    volumes:
      - ${CLOUDFLARE_CONFIG_FILE}:/etc/cloudflared/config.yml:ro
      - ${CLOUDFLARE_CREDENTIALS_DIR}:/etc/cloudflared/.cloudflared:ro
    command: tunnel --config /etc/cloudflared/config.yml run

  # =============================================================================
  # ERROR PAGES - CUSTOM ERROR PAGES FOR TRAEFIK
  # =============================================================================
  # Provides custom error pages (404, 500, etc.) for Traefik
  # Themes: ghost, l7-light, l7-dark, shuffle, noise, hacker-terminal, cats, lost-in-space, app-down, connection, orient
  # Full list: https://github.com/tarampampam/error-pages
  # =============================================================================
  error-pages:
    image: tarampampam/error-pages:latest
    container_name: error-pages
    restart: unless-stopped
    networks:
      - traefik-network
      - shared-network
    profiles:
      - all
      - networking
    environment:
      TEMPLATE_NAME: ${ERROR_PAGES_THEME:-ghost}
      SHOW_DETAILS: ${ERROR_PAGES_SHOW_DETAILS:-false}
    deploy:
      resources:
        limits:
          memory: ${ERROR_PAGES_MEMORY_LIMIT:-64m}
    labels:
      # Glance Configuration
      - glance.parent=traefik
      - glance.name=Error Pages
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.services.error-pages.loadbalancer.server.port=8080
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}

  # =============================================================================
  # PI-HOLE - NETWORK-WIDE AD BLOCKING & DNS (INTERNAL ONLY)
  # =============================================================================
  # Pi-Hole provides DNS-level ad blocking for your entire network.
  # NOT exposed via Traefik - access only via local IP:port
  # 
  # After starting, set your router's DNS to point to this server's IP
  # Web interface: http://${HOST_IP}:${PIHOLE_PORT_WEB}/admin
  # =============================================================================
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    hostname: pihole
    networks:
      - traefik-network
      - shared-network
    profiles:
      - all
      - networking
    depends_on:
      pihole-dnsmasq-init:
        condition: service_completed_successfully
    ports:
      # DNS ports - may conflict with systemd-resolved on Linux
      # If conflict, run: sudo systemctl disable systemd-resolved
      - "${PIHOLE_PORT_DNS:-53}:53/tcp"
      - "${PIHOLE_PORT_DNS:-53}:53/udp"
      # Web interface (internal access only)
      - "${PIHOLE_PORT_WEB:-8088}:80/tcp"
    environment:
      TZ: ${TIMEZONE:-UTC}
      WEBPASSWORD: ${PIHOLE_WEBPASSWORD:-pihole-admin-2024}
      PIHOLE_DNS_: ${PIHOLE_DNS1:-1.1.1.1};${PIHOLE_DNS2:-1.0.0.1}
      FTLCONF_webserver_api_password: ${PIHOLE_WEBPASSWORD:-pihole-admin-2024}
      DNSMASQ_LISTENING: all
      # Disable DHCP - use router for DHCP
      DHCP_ACTIVE: "false"
    volumes:
      - type: bind
        source: ${CONFIG_BASE_DIR:-./config}/pihole/etc-pihole
        target: /etc/pihole
        bind:
          create_host_path: true
      - type: bind
        source: ${CONFIG_BASE_DIR:-./config}/pihole/etc-dnsmasq.d
        target: /etc/dnsmasq.d
        bind:
          create_host_path: true
    cap_add:
      - NET_ADMIN
    deploy:
      resources:
        limits:
          memory: ${PIHOLE_MEMORY_LIMIT:-512m}
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # Glance Configuration
      - glance.id=pihole
      - glance.group=Networking
      - glance.name=Pi-hole
      - glance.icon=si:pihole
      - glance.url=/go/pihole
      - glance.description=DNS Ad Blocker
      - glance.hide=true
      
      # Traefik Configuration
      # Local-only Pi-hole admin (HTTP, no TLS) on http://pihole.lab/admin
      # This is NOT exposed via Cloudflare tunnel (router is web-only).
      - traefik.enable=true
      
      # HTTP router with redirect to /admin
      - traefik.http.routers.pihole-lab-http.entrypoints=web
      - traefik.http.routers.pihole-lab-http.rule=Host(`pihole.${LAB_DOMAIN}`)
      - traefik.http.routers.pihole-lab-http.middlewares=redirect-to-https@file
      - traefik.http.routers.pihole-lab-http.service=pihole
      
      # HTTPS router for .lab domain with /admin redirect
      - traefik.http.routers.pihole-lab.entrypoints=websecure
      - traefik.http.routers.pihole-lab.rule=Host(`pihole.${LAB_DOMAIN}`)
      - traefik.http.routers.pihole-lab.tls=true
      - traefik.http.routers.pihole-lab.middlewares=pihole-redirect
      - traefik.http.routers.pihole-lab.service=pihole
      
      # Middleware to redirect to /admin
      - traefik.http.middlewares.pihole-redirect.redirectregex.regex=^https?://([^/]+)/?$$
      - traefik.http.middlewares.pihole-redirect.redirectregex.replacement=http://$$1/admin/
      
      # Service definition
      - traefik.http.services.pihole.loadbalancer.server.port=80
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}
      - "com.docker.compose.service=pihole"
      - "description=Pi-Hole - Network-wide Ad Blocking (Internal Only)"

networks:
  traefik-network:
    name: traefik-network
    driver: bridge
