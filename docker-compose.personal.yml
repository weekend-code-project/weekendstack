# ====================================================================
# PERSONAL SERVICES - DOCKER COMPOSE CONFIGURATION
# ====================================================================
# This file contains personal lifestyle services:
# - Mealie: Meal planning and recipe manager
# - Firefly III: Personal finance manager
# - wger: Workout and fitness tracker
#
# Usage:
#   docker compose --profile personal up -d
#
# ====================================================================

networks:
  personal-network:
    name: personal-network
    driver: bridge
    external: false

services:
  # ====================================================================
  # MEALIE - Meal Planning & Recipe Manager
  # ====================================================================
  mealie:
    image: ghcr.io/mealie-recipes/mealie:latest
    container_name: mealie
    networks:
      - personal-network
      - shared-network
    profiles:
      - personal
    ports:
      - "${MEALIE_PORT:-9925}:9000"
    environment:
      ALLOW_SIGNUP: "true"
      PUID: 1000
      PGID: 1000
      TZ: ${TZ:-America/New_York}
      MAX_WORKERS: 1
      WEB_CONCURRENCY: 1
      BASE_URL: "https://mealie.${BASE_DOMAIN}"
    volumes:
      - type: volume
        source: mealie-data
        target: /app/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${MEALIE_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=mealie
      - glance.name=Mealie
      - glance.icon=si:docker
      - glance.url=/go/mealie
      - glance.description=Recipe Manager
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.mealie.rule=Host(`mealie.${BASE_DOMAIN}`)
      - traefik.http.routers.mealie.entrypoints=websecure
      - traefik.http.routers.mealie.tls=true
      - traefik.http.services.mealie.loadbalancer.server.port=9000
      - traefik.docker.network=shared-network

      - traefik.http.routers.mealie-http.entrypoints=web
      - traefik.http.routers.mealie-http.rule=Host(`mealie.lab`)
      - traefik.http.routers.mealie-http.service=mealie

  # ====================================================================
  # FIREFLY III - Personal Finance Manager
  # ====================================================================
  firefly:
    image: fireflyiii/core:latest
    container_name: firefly
    networks:
      - personal-network
      - shared-network
    profiles:
      - personal
    ports:
      - "${FIREFLY_PORT:-8086}:8080"
    environment:
      APP_KEY: ${FIREFLY_APP_KEY:-SomeRandomStringOf32CharsExactly}
      DB_CONNECTION: sqlite
      TZ: ${TZ:-America/New_York}
      TRUSTED_PROXIES: "**"
      APP_URL: "https://firefly.${BASE_DOMAIN}"
    volumes:
      - type: volume
        source: firefly-upload
        target: /var/www/html/storage/upload
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${FIREFLY_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=firefly
      - glance.name=Firefly III
      - glance.icon=si:docker
      - glance.url=/go/firefly
      - glance.description=Personal Finance
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.firefly.rule=Host(`firefly.${BASE_DOMAIN}`)
      - traefik.http.routers.firefly.entrypoints=websecure
      - traefik.http.routers.firefly.tls=true
      - traefik.http.services.firefly.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

      - traefik.http.routers.firefly-http.entrypoints=web
      - traefik.http.routers.firefly-http.rule=Host(`firefly.lab`)
      - traefik.http.routers.firefly-http.service=firefly

  # ====================================================================
  # WGER - Workout & Fitness Tracker
  # ====================================================================
  wger:
    image: wger/server:latest
    container_name: wger
    labels:
      - glance.id=wger
      - glance.name=Wger
      - glance.icon=si:docker
      - glance.url=/go/wger
      - glance.description=Workout Manager
    networks:
      - personal-network
    profiles:
      - personal
    expose:
      - "8000"
    environment:
      SECRET_KEY: ${WGER_SECRET_KEY:-wger-secret-key-change-me-in-production}
      DJANGO_DEBUG: "False"
      WGER_INSTANCE: "https://wger.${BASE_DOMAIN}"
      SITE_URL: "https://wger.${BASE_DOMAIN}"
      TIME_ZONE: ${TZ:-America/New_York}
      ALLOW_REGISTRATION: "True"
      ALLOW_GUEST_USERS: "False"
    volumes:
      - type: volume
        source: wger-static
        target: /home/wger/static
      - type: volume
        source: wger-media
        target: /home/wger/media
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${WGER_MEMORY_LIMIT:-512m}

  # WGER Nginx - Static file server for wger
  wger-nginx:
    image: nginx:stable
    container_name: wger-nginx
    networks:
      - personal-network
      - shared-network
    profiles:
      - personal
    ports:
      - "${WGER_PORT:-8089}:80"
    depends_on:
      - wger
    volumes:
      - type: volume
        source: wger-static
        target: /home/wger/static
        read_only: true
      - type: volume
        source: wger-media
        target: /home/wger/media
        read_only: true
      - type: bind
        source: ./config/wger/nginx.conf
        target: /etc/nginx/conf.d/default.conf
        read_only: true
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64m
    labels:
      # Glance Configuration
      - glance.parent=wger
      - glance.name=Nginx
      - glance.icon=si:docker
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.wger.rule=Host(`wger.${BASE_DOMAIN}`)
      - traefik.http.routers.wger.entrypoints=websecure
      - traefik.http.routers.wger.tls=true
      - traefik.http.services.wger.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

      - traefik.http.routers.wger-http.entrypoints=web
      - traefik.http.routers.wger-http.rule=Host(`wger.lab`)
      - traefik.http.routers.wger-http.service=wger

volumes:
  mealie-data:
  firefly-upload:
  wger-static:
  wger-media:
