# =============================================================================
# CORE AI DEV STACK - BASE CONFIGURATION  
# =============================================================================
# This file contains the essential infrastructure services
# Additional services are defined in separate compose files

networks:
  core-network:
    name: core-network
    driver: bridge
    external: false

# Global volumes for database storage (managed by Docker)
volumes:
  # Core service databases
  coder-db-data:
  gitea-db-data:
  vaultwarden-data:

services:
  # =============================================================================
  # HOMER - SERVICE DASHBOARD / LANDING PAGE
  # =============================================================================
  # A simple, lightweight dashboard to access all services from one place.
  # Access at http://<your-ip>:8080 or via Traefik at your root domain.
  #
  # Configuration: Edit files/homer/config.yml to customize the dashboard.
  # =============================================================================
  homer:
    image: b4bz/homer:latest
    container_name: homer
    restart: unless-stopped
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    ports:
      - "${HOMER_PORT:-8080}:8080"
    environment:
      - INIT_ASSETS=1
    volumes:
      - type: bind
        source: ./config/homer
        target: /www/assets
        bind:
          create_host_path: true
    deploy:
      resources:
        limits:
          memory: ${HOMER_MEMORY_LIMIT:-128m}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=${HOMER_TRAEFIK_ENABLE:-true}
      - "traefik.http.routers.homer.rule=Host(`${HOMER_DOMAIN:-dashboard-${COMPUTER_NAME}.${BASE_DOMAIN}}`)"
      - traefik.http.routers.homer.entrypoints=web,websecure
      - traefik.http.routers.homer.tls=true
      - traefik.http.services.homer.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network
      - "com.docker.compose.service=homer"
      - "description=Homer - Service Dashboard"

  # =============================================================================
  # VAULTWARDEN - Password Manager (Bitwarden Compatible)
  # =============================================================================
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    ports:
      - "${VAULTWARDEN_PORT:-8222}:80"
    environment:
      DOMAIN: "https://${VAULTWARDEN_DOMAIN:-vault.${BASE_DOMAIN}}"
      SIGNUPS_ALLOWED: ${VAULTWARDEN_SIGNUPS_ALLOWED:-true}
      ADMIN_TOKEN: ${VAULTWARDEN_ADMIN_TOKEN:-}
      WEBSOCKET_ENABLED: "true"
    volumes:
      - type: volume
        source: vaultwarden-data
        target: /data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${VAULTWARDEN_MEMORY_LIMIT:-256m}
    labels:
      - traefik.enable=true
      - traefik.http.routers.vaultwarden.rule=Host(`${VAULTWARDEN_DOMAIN:-vault.${BASE_DOMAIN}}`)
      - traefik.http.routers.vaultwarden.entrypoints=web,websecure
      - traefik.http.routers.vaultwarden.tls=true
      - traefik.http.services.vaultwarden.loadbalancer.server.port=80
      - traefik.docker.network=shared-network


