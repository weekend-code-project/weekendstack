# =============================================================================
# CORE AI DEV STACK - BASE CONFIGURATION  
# =============================================================================
# This file contains the essential infrastructure services
# Additional services are defined in separate compose files

networks:
  core-network:
    name: core-network
    driver: bridge
    external: false

# Global volumes for database storage (managed by Docker)
volumes:
  # Core service databases
  coder-db-data:
  gitea-db-data:
  vaultwarden-data:

services:
  # =============================================================================
  # GLANCE - DASHBOARD / START PAGE
  # =============================================================================
  # YAML-configured dashboard with widgets (RSS, monitoring, docker status, etc.)
  # Config: ./config/glance/glance.yml
  # Local: http://home.lab (Traefik) or http://192.168.2.50:8080
  # =============================================================================
  link-router:
    build:
      context: ./config/link-router
    container_name: link-router
    restart: unless-stopped
    profiles:
      - all
      - core
    environment:
      HOST_IP: ${HOST_IP:-192.168.2.50}
      LAB_DOMAIN: ${LAB_DOMAIN:-lab}
      BASE_DOMAIN: ${BASE_DOMAIN}
      LAB_SCHEME: ${LAB_SCHEME:-http}
      EXTERNAL_SCHEME: ${EXTERNAL_SCHEME:-https}
      FORCE_LINK_MODE: ${FORCE_LINK_MODE:-}
      PORT: 8080
    networks:
      - shared-network
    labels:
      # Glance Configuration
      - glance.parent=glance
      - glance.name=Link Router
      
      # Traefik Configuration
      - traefik.enable=true
      # HTTPS (Tunnel / public)
      - traefik.http.routers.link-router.rule=(Host(`glance.${LAB_DOMAIN:-lab}`) || Host(`glance.${BASE_DOMAIN}`)) && (PathPrefix(`/go/`) || PathPrefix(`/go-external/`))
      - traefik.http.routers.link-router.entrypoints=websecure
      - traefik.http.routers.link-router.tls=${TRAEFIK_TLS_ENABLE:-true}
      - traefik.http.routers.link-router.priority=100

      # HTTP (Local .lab and IP access)
      - traefik.http.routers.link-router-http.rule=PathPrefix(`/go/`) || PathPrefix(`/go-external/`)
      - traefik.http.routers.link-router-http.entrypoints=web
      - traefik.http.routers.link-router-http.priority=100
      - traefik.http.routers.link-router-http.service=link-router

      - traefik.http.services.link-router.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

  glance:
    image: glanceapp/glance:latest
    container_name: glance
    restart: unless-stopped
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    # Port removed - access via Traefik on port 80 instead
    # Emergency fallback: uncomment to enable direct access on port 8080
    # ports:
    #   - "${HOST_IP:-192.168.2.50}:${GLANCE_PORT:-8080}:8080"
    environment:
      HOST_IP: ${HOST_IP:-192.168.2.50}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
      CLOUDFLARE_TUNNEL_ID: ${CLOUDFLARE_TUNNEL_ID}
      CLOUDFLARE_API_KEY: ${CLOUDFLARE_API_KEY}
      IMMICH_URL: ${IMMICH_URL}
      IMMICH_API_KEY: ${IMMICH_API_KEY}
      PAPERLESS_URL: ${PAPERLESS_URL}
      PAPERLESS_API_KEY: ${PAPERLESS_API_KEY}
      SPEEDTEST_URL: ${SPEEDTEST_URL}
      SPEEDTEST_TRACKER_API_TOKEN: ${SPEEDTEST_TRACKER_API_TOKEN}
      WUD_URL: ${WUD_URL}
      WUD_AUTH_USER: ${WUD_AUTH_USER:-admin}
      WUD_AUTH_PASSWORD: ${WUD_AUTH_PASSWORD:-admin}
    volumes:
      - type: bind
        source: ./config/glance/glance.yml
        target: /app/config/glance.yml
        read_only: true
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      resources:
        limits:
          memory: ${GLANCE_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=glance
      - glance.group=Core
      - glance.name=Glance Dashboard
      - glance.icon=si:homeassistant
      - glance.url=/go/home
      - glance.description=Dashboard
      - glance.hide=true
      
      # Traefik Configuration
      - traefik.enable=true
      # Local HTTP access
      - traefik.http.routers.glance-http.entrypoints=web
      - traefik.http.routers.glance-http.rule=Host(`home.lab`) || Host(`${HOST_IP}`)
      - traefik.http.routers.glance-http.service=glance
      # Local HTTPS access
      - traefik.http.routers.glance-https.entrypoints=websecure
      - traefik.http.routers.glance-https.rule=Host(`home.lab`)
      - traefik.http.routers.glance-https.tls=true
      - traefik.http.routers.glance-https.service=glance
      # Service definition
      - traefik.http.services.glance.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

      - "com.docker.compose.service=glance"
      - "description=Glance - Dashboard / Start Page"

  # =============================================================================
  # VAULTWARDEN - Password Manager (Bitwarden Compatible)
  # =============================================================================
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    networks:
      - core-network
      - shared-network
    profiles:
      - all
      - core
    ports:
      - "${VAULTWARDEN_PORT:-8222}:80"
    environment:
      # Use HTTP for local access - the web vault will work with both HTTP and HTTPS
      DOMAIN: "http://${HOST_IP}:8222"
      SIGNUPS_ALLOWED: ${VAULTWARDEN_SIGNUPS_ALLOWED:-true}
      ADMIN_TOKEN: ${VAULTWARDEN_ADMIN_TOKEN:-}
      WEBSOCKET_ENABLED: "true"
    volumes:
      - type: volume
        source: vaultwarden-data
        target: /data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${VAULTWARDEN_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=vaultwarden
      - glance.group=Core
      - glance.name=Vaultwarden
      - glance.icon=si:vaultwarden
      - glance.url=/go/vaultwarden
      - glance.description=Password Manager
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.${BASE_DOMAIN}`) || Host(`vault.${BASE_DOMAIN}`)
      - traefik.http.routers.vaultwarden.entrypoints=websecure
      - traefik.http.routers.vaultwarden.tls=true
      - traefik.http.services.vaultwarden.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

      # Local HTTP access for *.lab
      - traefik.http.routers.vaultwarden-http.entrypoints=web
      - traefik.http.routers.vaultwarden-http.rule=Host(`vaultwarden.lab`) || Host(`vault.lab`)
      - traefik.http.routers.vaultwarden-http.service=vaultwarden


