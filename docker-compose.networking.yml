# =============================================================================
# NETWORKING SERVICES - REVERSE PROXY, TUNNELS, AND DNS
# =============================================================================
# This file contains networking infrastructure services:
# - Traefik: Reverse proxy and load balancer
# - Cloudflare Tunnel: Secure external access
# - Pi-Hole: Network-wide ad blocking and DNS (internal only)
#
# Usage:
#   docker compose --profile networking up -d
#   docker compose --profile proxy up -d  (legacy alias)
# =============================================================================

services:
  # =============================================================================
  # PI-HOLE DNSMASQ INIT - GENERATE PORTABLE LOCAL DNS RULES
  # =============================================================================
  # Generates dnsmasq config files in the bind-mounted directory so new checkouts
  # only need to set HOST_IP in .env (and optionally LAN_DNS_SERVER/LAN_DOMAIN).
  #
  # - 02-custom-lab.conf: wildcard *.lab -> ${HOST_IP}
  # - 03-forward-lan-to-router.conf (optional): forward *.${LAN_DOMAIN} to LAN_DNS_SERVER
  #
  # This container exits after writing files.
  pihole-dnsmasq-init:
    image: alpine:3.20
    container_name: pihole-dnsmasq-init
    restart: "no"
    profiles:
      - all
      - networking
    environment:
      HOST_IP: ${HOST_IP}
      LAB_DOMAIN: ${LAB_DOMAIN:-lab}
      LAN_DOMAIN: ${LAN_DOMAIN:-lan}
      LAN_DNS_SERVER: ${LAN_DNS_SERVER:-}
      ENABLE_LAN_DOMAIN_FORWARDING: ${ENABLE_LAN_DOMAIN_FORWARDING:-false}
    labels:
      - glance.parent=pihole
      - glance.name=Init Container
    volumes:
      - type: bind
        source: ${CONFIG_BASE_DIR:-./config}/pihole/etc-dnsmasq.d
        target: /dnsmasq.d
        bind:
          create_host_path: true
    command:
      - /bin/sh
      - -lc
      - |
        set -eu
        if [ -z "$${HOST_IP:-}" ]; then
          echo "ERROR: HOST_IP is required for Pi-hole local DNS rules" >&2
          exit 1
        fi

        : "$${LAB_DOMAIN:=lab}"
        if ! echo "$$LAB_DOMAIN" | grep -Eq '^[A-Za-z0-9-]+$'; then
          echo "ERROR: LAB_DOMAIN must be a simple label (e.g. 'lab')" >&2
          exit 1
        fi

        mkdir -p /dnsmasq.d

        {
          echo "# Generated by pihole-dnsmasq-init (docker compose)"
          echo "# Wildcard DNS for .$${LAB_DOMAIN} domain"
          echo "# Routes all *.$${LAB_DOMAIN} domains to the Docker host running Traefik"
          echo "address=/.$${LAB_DOMAIN}/$${HOST_IP}"
        } > /dnsmasq.d/02-custom-lab.conf

        if [ "$${ENABLE_LAN_DOMAIN_FORWARDING:-false}" = "true" ]; then
          if [ -z "$${LAN_DNS_SERVER:-}" ]; then
            echo "ERROR: ENABLE_LAN_DOMAIN_FORWARDING=true but LAN_DNS_SERVER is empty" >&2
            exit 1
          fi
          : "$${LAN_DOMAIN:=lan}"
          if ! echo "$$LAN_DOMAIN" | grep -Eq '^[A-Za-z0-9-]+$'; then
            echo "ERROR: LAN_DOMAIN must be a simple label (e.g. 'lan')" >&2
            exit 1
          fi
          {
            echo "# Generated by pihole-dnsmasq-init (docker compose)"
            echo "# Forward *.$${LAN_DOMAIN} queries to your router/LAN DNS"
            echo "server=/$${LAN_DOMAIN}/$${LAN_DNS_SERVER}"
          } > /dnsmasq.d/03-forward-lan-to-router.conf
        else
          rm -f /dnsmasq.d/03-forward-lan-to-router.conf || true
        fi

        echo "Wrote dnsmasq rules to /dnsmasq.d"

  # =============================================================================
  # TRAEFIK - REVERSE PROXY
  # =============================================================================
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    profiles:
      - all
      - proxy
      - networking
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      - ${TRAEFIK_CONFIG_FILE}:/etc/traefik/traefik.yml:ro
      - ${TRAEFIK_AUTH_DIR}:/traefik-auth:ro
    networks:
      - coder-network
      - traefik-network
      - shared-network
    depends_on:
      - socat
    labels:
      # Glance Configuration
      - glance.id=traefik
      - glance.name=Traefik
      - glance.icon=si:traefikproxy
      - glance.url=/go/traefik
      - glance.description=Reverse Proxy
      
      # Traefik Configuration
      - traefik.enable=true
      # Local-only Traefik dashboard (HTTP, no TLS) on http://traefik.lab/dashboard/
      - traefik.http.routers.traefik-dashboard-http.rule=Host(`traefik.lab`)
      - traefik.http.routers.traefik-dashboard-http.entrypoints=web
      - traefik.http.routers.traefik-dashboard-http.service=api@internal
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.endpoint=tcp://socat:2375
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

  # =============================================================================
  # CLOUDFLARE TUNNEL - SECURE EXTERNAL ACCESS
  # =============================================================================
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    labels:
      - glance.hide=true
    restart: unless-stopped
    networks:
      - traefik-network
      - shared-network
    profiles:
      - proxy
      - external
    volumes:
      - ${CLOUDFLARE_CONFIG_FILE}:/etc/cloudflared/config.yml:ro
      - ${CLOUDFLARE_CREDENTIALS_DIR}:/etc/cloudflared/.cloudflared:ro
    command: tunnel --config /etc/cloudflared/config.yml run

  # =============================================================================
  # ERROR PAGES - CUSTOM ERROR PAGES FOR TRAEFIK
  # =============================================================================
  # Provides custom error pages (404, 500, etc.) for Traefik
  # Themes: ghost, l7-light, l7-dark, shuffle, noise, hacker-terminal, cats, lost-in-space, app-down, connection, orient
  # Full list: https://github.com/tarampampam/error-pages
  # =============================================================================
  error-pages:
    image: tarampampam/error-pages:latest
    container_name: error-pages
    restart: unless-stopped
    networks:
      - traefik-network
      - shared-network
    profiles:
      - all
      - networking
    environment:
      TEMPLATE_NAME: ${ERROR_PAGES_THEME:-ghost}
      SHOW_DETAILS: ${ERROR_PAGES_SHOW_DETAILS:-false}
    deploy:
      resources:
        limits:
          memory: ${ERROR_PAGES_MEMORY_LIMIT:-64m}
    labels:
      # Glance Configuration
      - glance.parent=traefik
      - glance.name=Error Pages
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.services.error-pages.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

  # =============================================================================
  # PI-HOLE - NETWORK-WIDE AD BLOCKING & DNS (INTERNAL ONLY)
  # =============================================================================
  # Pi-Hole provides DNS-level ad blocking for your entire network.
  # NOT exposed via Traefik - access only via local IP:port
  # 
  # After starting, set your router's DNS to point to this server's IP
  # Web interface: http://${HOST_IP}:${PIHOLE_PORT_WEB}/admin
  # =============================================================================
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    hostname: pihole
    networks:
      - traefik-network
      - shared-network
    profiles:
      - all
      - networking
    depends_on:
      pihole-dnsmasq-init:
        condition: service_completed_successfully
    ports:
      # DNS ports - may conflict with systemd-resolved on Linux
      # If conflict, run: sudo systemctl disable systemd-resolved
      - "${PIHOLE_PORT_DNS:-53}:53/tcp"
      - "${PIHOLE_PORT_DNS:-53}:53/udp"
      # Web interface (internal access only)
      - "${PIHOLE_PORT_WEB:-8088}:80/tcp"
    environment:
      TZ: ${TIMEZONE:-UTC}
      WEBPASSWORD: ${PIHOLE_WEBPASSWORD:-pihole-admin-2024}
      PIHOLE_DNS_: ${PIHOLE_DNS1:-1.1.1.1};${PIHOLE_DNS2:-1.0.0.1}
      FTLCONF_webserver_api_password: ${PIHOLE_WEBPASSWORD:-pihole-admin-2024}
      DNSMASQ_LISTENING: all
      # Disable DHCP - use router for DHCP
      DHCP_ACTIVE: "false"
    volumes:
      - type: bind
        source: ${CONFIG_BASE_DIR:-./config}/pihole/etc-pihole
        target: /etc/pihole
        bind:
          create_host_path: true
      - type: bind
        source: ${CONFIG_BASE_DIR:-./config}/pihole/etc-dnsmasq.d
        target: /etc/dnsmasq.d
        bind:
          create_host_path: true
    cap_add:
      - NET_ADMIN
    deploy:
      resources:
        limits:
          memory: ${PIHOLE_MEMORY_LIMIT:-512m}
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # Glance Configuration
      - glance.id=pihole
      - glance.name=Pi-hole
      - glance.icon=si:pihole
      - glance.url=/go/pihole
      - glance.description=DNS Ad Blocker
      
      # Traefik Configuration
      # Local-only Pi-hole admin (HTTP, no TLS) on http://pihole.lab/admin
      # This is NOT exposed via Cloudflare tunnel (router is web-only).
      - traefik.enable=true
      - traefik.http.routers.pihole-http.rule=Host(`pihole.lab`)
      - traefik.http.routers.pihole-http.entrypoints=web
      - traefik.http.services.pihole.loadbalancer.server.port=80
      - "com.docker.compose.service=pihole"
      - "description=Pi-Hole - Network-wide Ad Blocking (Internal Only)"

networks:
  traefik-network:
    name: traefik-network
    driver: bridge
