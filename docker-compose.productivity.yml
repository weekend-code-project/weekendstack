# =============================================================================
# PRODUCTIVITY SERVICES - DOCKER COMPOSE CONFIGURATION
# =============================================================================
# This file contains productivity-focused services:
# - NocoDB: Airtable alternative for database management
# - Paperless-ngx: Document management system
#
# Usage:
#   docker compose --profile productivity up -d
#
# Data Storage:
#   Persistent state lives under ./volumes/ and user-facing files under ./files/ (both configurable via .env)
# =============================================================================

networks:
  productivity-network:
    name: productivity-network
    driver: bridge
    external: false

services:
  # =============================================================================
  # NOCODB - AIRTABLE ALTERNATIVE
  # =============================================================================
  
  nocodb-db:
    image: postgres:15-alpine
    container_name: nocodb-db
    labels:
      - glance.parent=nocodb
      - glance.name=Database
    environment:
      POSTGRES_DB: ${NOCODB_DBNAME:-nocodb}
      POSTGRES_USER: ${NOCODB_DBUSER:-nocodb}
      POSTGRES_PASSWORD: ${NOCODB_DBPASS:-nocodb_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${NOCODB_DBUSER:-nocodb} -d ${NOCODB_DBNAME:-nocodb}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - type: volume
        source: nocodb-db-data
        target: /var/lib/postgresql/data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped

  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb
    depends_on:
      nocodb-db:
        condition: service_healthy
    environment:
      # Database Configuration
      NC_DB: "pg://nocodb-db:5432?u=${NOCODB_DBUSER:-nocodb}&p=${NOCODB_DBPASS:-nocodb_password_2024}&d=${NOCODB_DBNAME:-nocodb}"
      
      # Security Configuration
      NC_JWT_EXPIRES_IN: "10h"
      NC_JWT_SECRET: ${NOCODB_JWT_SECRET}
      NC_AUTH_JWT_SECRET: ${NOCODB_AUTH_JWT_SECRET}
      
      # Application Configuration
      # Default to local *.lab for LAN HTTP access; override to https://nocodb.${BASE_DOMAIN} later.
      NC_PUBLIC_URL: ${NOCODB_PUBLIC_URL:-http://nocodb.lab}
      NC_DISABLE_TELE: true
      NC_REDIS_URL: ""
      
      # Admin Configuration
      NC_ADMIN_EMAIL: admin@example.com
      NC_ADMIN_PASSWORD: ${NOCODB_ADMIN_PASSWORD:-secure_nocodb_password_2024}
      
    volumes:
      - type: bind
        source: ${DATA_BASE_DIR:-./data}/nocodb
        target: /usr/app/data
    networks:
      - productivity-network
      - shared-network
    ports:
      - "${NOCODB_PORT}:8080"
    restart: unless-stopped
    profiles:
      - all
      - productivity
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/v1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: ${NOCODB_MEMORY_LIMIT}
    labels:
      # Glance Configuration
      - glance.id=nocodb
      - glance.name=NocoDB
      - glance.icon=si:airtable
      - glance.url=/go/nocodb
      - glance.description=Airtable Alternative Database
      
      # Traefik Configuration for external access
      - traefik.enable=true
      - traefik.http.routers.nocodb.rule=Host(`nocodb.${BASE_DOMAIN}`)
      - traefik.http.routers.nocodb.entrypoints=websecure
      - traefik.http.routers.nocodb.tls=true
      - traefik.http.services.nocodb.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

      - traefik.http.routers.nocodb-http.entrypoints=web
      - traefik.http.routers.nocodb-http.rule=Host(`nocodb.lab`)
      - traefik.http.routers.nocodb-http.service=nocodb
      
      # Additional labels for documentation
      - "com.docker.compose.service=nocodb"
      - "com.docker.compose.project=${COMPOSE_PROJECT_NAME:-coder}"
      - "description=NocoDB - Airtable Alternative Database Management"

  # =============================================================================
  # N8N - WORKFLOW AUTOMATION
  # =============================================================================

  n8n-db:
    image: postgres:15-alpine
    container_name: n8n-db
    labels:
      - glance.parent=n8n
      - glance.name=Database
    environment:
      POSTGRES_DB: ${N8N_DBNAME:-n8n}
      POSTGRES_USER: ${N8N_DBUSER:-n8n}
      POSTGRES_PASSWORD: ${N8N_DBPASS:-n8n_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - type: volume
        source: n8n-db-data
        target: /var/lib/postgresql/data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_DBUSER:-n8n} -d ${N8N_DBNAME:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512m

  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    user: "1000:1000"
    depends_on:
      n8n-db:
        condition: service_healthy
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # Database Configuration
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n-db
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${N8N_DBNAME:-n8n}
      DB_POSTGRESDB_USER: ${N8N_DBUSER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${N8N_DBPASS:-n8n_password_2024}
      DB_POSTGRESDB_SCHEMA: public
      
      # Application Configuration
      N8N_HOST: 0.0.0.0
      N8N_PORT: 5678
      # Default to local *.lab for LAN HTTP access; override to https://n8n.${BASE_DOMAIN} later.
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://n8n.lab/}
      GENERIC_TIMEZONE: ${TIMEZONE:-America/New_York}
      TZ: ${TIMEZONE:-America/New_York}
      
      # Security Configuration
      N8N_BASIC_AUTH_ACTIVE: false
      N8N_DISABLE_UI: false
      # Cookies must not be marked secure on plain HTTP.
      N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE:-false}
    volumes:
      - type: bind
        source: ${DATA_BASE_DIR:-./data}/n8n
        target: /home/node/.n8n
    networks:
      - productivity-network
      - shared-network
    deploy:
      resources:
        limits:
          memory: ${N8N_MEMORY_LIMIT:-2g}
    profiles:
      - all
      - productivity
    labels:
      # Glance Configuration
      - glance.id=n8n
      - glance.name=n8n
      - glance.icon=si:n8n
      - glance.url=/go/n8n
      - glance.description=Workflow Automation
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.n8n.rule=Host(`n8n.${BASE_DOMAIN}`)
      - traefik.http.routers.n8n.entrypoints=websecure
      - traefik.http.routers.n8n.tls=true
      - traefik.http.services.n8n.loadbalancer.server.port=5678
      - traefik.docker.network=shared-network

      - traefik.http.routers.n8n-http.entrypoints=web
      - traefik.http.routers.n8n-http.rule=Host(`n8n.lab`)
      - traefik.http.routers.n8n-http.service=n8n
      
      # Additional labels for documentation
      - "com.docker.compose.service=n8n"
      - "com.docker.compose.project=${COMPOSE_PROJECT_NAME:-coder}"
      - "description=N8N - Workflow Automation Platform"

  # =============================================================================
  # PAPERLESS-NGX - DOCUMENT MANAGEMENT SYSTEM
  # =============================================================================
  
  paperless-db:
    image: postgres:15-alpine
    container_name: paperless-db
    labels:
      - glance.parent=paperless
      - glance.name=Database
    environment:
      POSTGRES_DB: ${PAPERLESS_DBNAME:-paperless}
      POSTGRES_USER: ${PAPERLESS_DBUSER:-paperless}
      POSTGRES_PASSWORD: ${PAPERLESS_DBPASS:-paperless_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PAPERLESS_DBUSER:-paperless} -d ${PAPERLESS_DBNAME:-paperless}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - type: volume
        source: paperless-db-data
        target: /var/lib/postgresql/data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped

  paperless-redis:
    image: redis:7-alpine
    container_name: paperless-redis
    labels:
      - glance.parent=paperless
      - glance.name=Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - type: volume
        source: paperless-redis-data
        target: /data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped

  paperless-ngx:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless-ngx
    depends_on:
      paperless-db:
        condition: service_healthy
      paperless-redis:
        condition: service_healthy
    environment:
      # Host IP for ALLOWED_HOSTS
      HOST_IP: ${HOST_IP}
      
      # Database Configuration
      PAPERLESS_DBHOST: paperless-db
      PAPERLESS_DBPORT: 5432
      PAPERLESS_DBNAME: ${PAPERLESS_DBNAME:-paperless}
      PAPERLESS_DBUSER: ${PAPERLESS_DBUSER:-paperless}
      PAPERLESS_DBPASS: ${PAPERLESS_DBPASS:-paperless_password_2024}
      
      # Redis Configuration
      PAPERLESS_REDIS: redis://paperless-redis:6379
      
      # Application Configuration
      # Default to local *.lab for LAN HTTP access; override to https://paperless.${BASE_DOMAIN} later.
      PAPERLESS_URL: ${PAPERLESS_URL:-http://paperless.lab}
      PAPERLESS_SECRET_KEY: ${PAPERLESS_SECRET_KEY:-paperless-secret-key-change-me-2024}
      PAPERLESS_TIME_ZONE: ${TIMEZONE:-UTC}
      PAPERLESS_OCR_LANGUAGE: eng
      
      # Admin User Configuration
      PAPERLESS_ADMIN_USER: ${PAPERLESS_ADMIN_USER:-admin}
      PAPERLESS_ADMIN_PASSWORD: ${PAPERLESS_ADMIN_PASSWORD:-secure_paperless_password_2024}
      PAPERLESS_ADMIN_MAIL: admin@localhost
      
      # Document Processing
      PAPERLESS_CONSUMER_POLLING: 10
      PAPERLESS_CONSUMER_DELETE_DUPLICATES: true
      PAPERLESS_CONSUMER_RECURSIVE: true
      PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS: true
      
      # Security
      PAPERLESS_ALLOWED_HOSTS: paperless.${BASE_DOMAIN},paperless.lab,localhost,127.0.0.1,${HOST_IP}
      PAPERLESS_CORS_ALLOWED_HOSTS: https://paperless.${BASE_DOMAIN},http://paperless.lab,http://${HOST_IP}:${PAPERLESS_PORT:-8082}
      
    volumes:
      - type: volume
        source: paperless-data
        target: /usr/src/paperless/data
      - type: bind
        source: ${FILES_BASE_DIR:-./files}/paperless/media
        target: /usr/src/paperless/media
      - type: bind
        source: ${FILES_BASE_DIR:-./files}/paperless/consume
        target: /usr/src/paperless/consume
      - type: bind
        source: ${FILES_BASE_DIR:-./files}/paperless/export
        target: /usr/src/paperless/export
    networks:
      - productivity-network
      - shared-network
    ports:
      - "${PAPERLESS_PORT:-8082}:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: ${PAPERLESS_MEMORY_LIMIT:-2g}
    profiles:
      - all
      - productivity
    labels:
      # Glance Configuration
      - glance.id=paperless
      - glance.name=Paperless-ngx
      - glance.icon=si:docker
      - glance.url=/go/paperless
      - glance.description=Document Management System
      
      # Traefik Configuration for external access
      - traefik.enable=true
      - traefik.http.routers.paperless.rule=Host(`paperless.${BASE_DOMAIN}`)
      - traefik.http.routers.paperless.entrypoints=websecure
      - traefik.http.routers.paperless.tls=true
      - traefik.http.services.paperless.loadbalancer.server.port=8000
      - traefik.docker.network=shared-network

      - traefik.http.routers.paperless-http.entrypoints=web
      - traefik.http.routers.paperless-http.rule=Host(`paperless.lab`)
      - traefik.http.routers.paperless-http.service=paperless
      
      # Additional labels for documentation
      - "com.docker.compose.service=paperless-ngx"
      - "com.docker.compose.project=${COMPOSE_PROJECT_NAME:-coder}"
      - "description=Paperless-ngx - Document Management and OCR System"

  # =============================================================================
  # ACTIVEPIECES - WORKFLOW AUTOMATION
  # =============================================================================

  activepieces-db:
    image: postgres:15-alpine
    container_name: activepieces-db
    labels:
      - glance.parent=activepieces
      - glance.name=Database
    environment:
      POSTGRES_DB: ${ACTIVEPIECES_DBNAME:-activepieces}
      POSTGRES_USER: ${ACTIVEPIECES_DBUSER:-activepieces}
      POSTGRES_PASSWORD: ${ACTIVEPIECES_DBPASS:-activepieces_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - type: volume
        source: activepieces-db-data
        target: /var/lib/postgresql/data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ACTIVEPIECES_DBUSER:-activepieces} -d ${ACTIVEPIECES_DBNAME:-activepieces}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512m

  activepieces-redis:
    image: redis:7-alpine
    container_name: activepieces-redis
    labels:
      - glance.parent=activepieces
      - glance.name=Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - type: volume
        source: activepieces-redis-data
        target: /data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity

  activepieces:
    image: activepieces/activepieces:latest
    container_name: activepieces
    restart: unless-stopped
    depends_on:
      activepieces-db:
        condition: service_healthy
      activepieces-redis:
        condition: service_healthy
    ports:
      - "${ACTIVEPIECES_PORT:-8087}:80"
    environment:
      # Database Configuration
      AP_POSTGRES_HOST: activepieces-db
      AP_POSTGRES_PORT: 5432
      AP_POSTGRES_DATABASE: ${ACTIVEPIECES_DBNAME:-activepieces}
      AP_POSTGRES_USERNAME: ${ACTIVEPIECES_DBUSER:-activepieces}
      AP_POSTGRES_PASSWORD: ${ACTIVEPIECES_DBPASS:-activepieces_password_2024}
      
      # Redis Configuration
      AP_REDIS_HOST: activepieces-redis
      AP_REDIS_PORT: 6379
      
      # Application Configuration
      # Default to local *.lab for LAN HTTP access; override to https://activepieces.${BASE_DOMAIN} later.
      AP_FRONTEND_URL: ${ACTIVEPIECES_FRONTEND_URL:-http://activepieces.lab}
      AP_WEBHOOK_URL: ${ACTIVEPIECES_WEBHOOK_URL:-http://activepieces.lab}
      AP_ENCRYPTION_KEY: ${ACTIVEPIECES_ENCRYPTION_KEY:-activepieces-encryption-key-change-me-2024}
      AP_JWT_SECRET: ${ACTIVEPIECES_JWT_SECRET:-activepieces-jwt-secret-change-me-2024}
      
      # Environment
      AP_ENVIRONMENT: prod
      AP_EXECUTION_MODE: UNSANDBOXED
      
      # Telemetry
      AP_TELEMETRY_ENABLED: false
      
      # Timezone
      TZ: ${TIMEZONE:-UTC}
      
    volumes:
      - type: volume
        source: activepieces-data
        target: /root/.activepieces
    networks:
      - productivity-network
      - shared-network
    deploy:
      resources:
        limits:
          memory: ${ACTIVEPIECES_MEMORY_LIMIT:-2g}
    profiles:
      - all
      - productivity
    labels:
      # Glance Configuration
      - glance.id=activepieces
      - glance.name=Activepieces
      - glance.icon=si:zapier
      - glance.url=/go/activepieces
      - glance.description=Workflow Automation
      
      # Traefik Configuration for external access
      - traefik.enable=true
      - traefik.http.routers.activepieces.rule=Host(`activepieces.${BASE_DOMAIN}`)
      - traefik.http.routers.activepieces.entrypoints=websecure
      - traefik.http.routers.activepieces.tls=true
      - traefik.http.services.activepieces.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

      - traefik.http.routers.activepieces-http.entrypoints=web
      - traefik.http.routers.activepieces-http.rule=Host(`activepieces.lab`)
      - traefik.http.routers.activepieces-http.service=activepieces
      
      # Additional labels for documentation
      - "com.docker.compose.service=activepieces"
      - "com.docker.compose.project=${COMPOSE_PROJECT_NAME:-coder}"
      - "description=Activepieces - Open Source Workflow Automation"

  # =============================================================================
  # POSTIZ - SELF-HOSTED SOCIAL MEDIA MANAGEMENT
  # =============================================================================

  postiz-db:
    image: postgres:15-alpine
    container_name: postiz-db
    labels:
      - glance.parent=postiz
      - glance.name=Database
    environment:
      POSTGRES_DB: ${POSTIZ_DBNAME:-postiz}
      POSTGRES_USER: ${POSTIZ_DBUSER:-postiz}
      POSTGRES_PASSWORD: ${POSTIZ_DBPASS:-postiz_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTIZ_DBUSER:-postiz} -d ${POSTIZ_DBNAME:-postiz}"]
      interval: 15s
      timeout: 5s
      retries: 5
    volumes:
      - type: volume
        source: postiz-db-data
        target: /var/lib/postgresql/data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity

  postiz-redis:
    image: redis:7-alpine
    container_name: postiz-redis
    labels:
      - glance.parent=postiz
      - glance.name=Redis
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 5
    volumes:
      - type: volume
        source: postiz-redis-data
        target: /data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity

  postiz:
    image: ghcr.io/gitroomhq/postiz-app:v2.10.1
    container_name: postiz
    depends_on:
      postiz-db:
        condition: service_healthy
      postiz-redis:
        condition: service_healthy
    environment:
      # Database Configuration
      DATABASE_URL: postgres://${POSTIZ_DBUSER:-postiz}:${POSTIZ_DBPASS:-postiz_password_2024}@postiz-db:5432/${POSTIZ_DBNAME:-postiz}
      
      # Redis Configuration
      REDIS_URL: redis://postiz-redis:6379
      
      # Application Configuration
      # Default to local *.lab for LAN HTTP access; override to https://postiz.${BASE_DOMAIN} later.
      MAIN_URL: ${POSTIZ_MAIN_URL:-http://postiz.lab}
      FRONTEND_URL: ${POSTIZ_FRONTEND_URL:-http://postiz.lab}
      NEXT_PUBLIC_BACKEND_URL: ${POSTIZ_NEXT_PUBLIC_BACKEND_URL:-http://postiz.lab/api}
      BACKEND_URL: http://localhost:3000
      BACKEND_INTERNAL_URL: http://localhost:3000
      NEXT_PUBLIC_BACKEND_INTERNAL_URL: http://localhost:3000
      NEXTAUTH_URL: ${POSTIZ_NEXTAUTH_URL:-http://postiz.lab}
      NEXTAUTH_SECRET: ${POSTIZ_NEXTAUTH_SECRET:-postiz-nextauth-secret-change-me-2024}
      JWT_SECRET: ${POSTIZ_JWT_SECRET:-postiz-jwt-secret-change-me-2024}
      BASE_URL: ${POSTIZ_BASE_URL:-http://postiz.lab}
      
      # Storage Configuration
      STORAGE_PROVIDER: local
      UPLOAD_DIRECTORY: /app/public/uploads
      
      # Admin Configuration
      ADMIN_EMAIL: ${POSTIZ_ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${POSTIZ_ADMIN_PASSWORD:-secure_postiz_password_2024}
      
      # Environment
      NODE_ENV: production
      TZ: ${TIMEZONE:-UTC}
      
    ports:
      - "${POSTIZ_PORT:-8095}:5000"
    volumes:
      - type: bind
        source: ${FILES_BASE_DIR:-./files}/postiz/uploads
        target: /app/public/uploads
      - type: bind
        source: ./config/postiz/nginx.conf
        target: /etc/nginx/nginx.conf
        read_only: true
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:5000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: ${POSTIZ_MEMORY_LIMIT:-2g}
    labels:
      # Glance Configuration
      - glance.id=postiz
      - glance.name=Postiz
      - glance.icon=si:hootsuite
      - glance.url=/go/postiz
      - glance.description=Social Media Management
      
      # Traefik Configuration for external access
      - traefik.enable=true
      - traefik.http.routers.postiz.rule=Host(`postiz.${BASE_DOMAIN}`)
      - traefik.http.routers.postiz.entrypoints=websecure
      - traefik.http.routers.postiz.tls=true
      - traefik.http.services.postiz.loadbalancer.server.port=5000
      - traefik.docker.network=shared-network

      - traefik.http.routers.postiz-http.entrypoints=web
      - traefik.http.routers.postiz-http.rule=Host(`postiz.lab`)
      - traefik.http.routers.postiz-http.service=postiz
      
      # Additional labels for documentation
      - "com.docker.compose.service=postiz"
      - "com.docker.compose.project=${COMPOSE_PROJECT_NAME:-coder}"
      - "description=Postiz - Self-hosted Social Media Scheduler"

  # ====================================================================
  # FOCALBOARD - Project Management (Trello/Asana Alternative)
  # ====================================================================
  focalboard:
    image: mattermost/focalboard:latest
    container_name: focalboard
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${FOCALBOARD_PORT:-8097}:8000"
    volumes:
      - type: volume
        source: focalboard-data
        target: /opt/focalboard/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${FOCALBOARD_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=focalboard
      - glance.name=Focalboard
      - glance.icon=si:mattermost
      - glance.url=/go/focalboard
      - glance.description=Project Management
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.focalboard.rule=Host(`focalboard.${BASE_DOMAIN}`)
      - traefik.http.routers.focalboard.entrypoints=websecure
      - traefik.http.routers.focalboard.tls=true
      - traefik.http.services.focalboard.loadbalancer.server.port=8000
      - traefik.docker.network=shared-network

      - traefik.http.routers.focalboard-http.entrypoints=web
      - traefik.http.routers.focalboard-http.rule=Host(`focalboard.lab`)
      - traefik.http.routers.focalboard-http.service=focalboard

  # =============================================================================
  # TRILIUM - Hierarchical Note-Taking
  # =============================================================================
  # A hierarchical note-taking application with focus on building large personal knowledge bases.
  # =============================================================================
  trilium:
    image: zadam/trilium:latest
    container_name: trilium
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${TRILIUM_PORT:-8085}:8080"
    environment:
      TRILIUM_DATA_DIR: /home/node/trilium-data
    volumes:
      - type: volume
        source: trilium-data
        target: /home/node/trilium-data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${TRILIUM_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=trilium
      - glance.name=Trilium
      - glance.icon=si:trilium
      - glance.url=/go/trilium
      - glance.description=Note Taking
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.trilium.rule=Host(`trilium.${BASE_DOMAIN}`)
      - traefik.http.routers.trilium.entrypoints=websecure
      - traefik.http.routers.trilium.tls=true
      - traefik.http.services.trilium.loadbalancer.server.port=8080
      - traefik.docker.network=shared-network

      - traefik.http.routers.trilium-http.entrypoints=web
      - traefik.http.routers.trilium-http.rule=Host(`trilium.lab`)
      - traefik.http.routers.trilium-http.service=trilium

  # =============================================================================
  # VIKUNJA - Task & Project Management
  # =============================================================================
  # A self-hosted open-source to-do app and project management tool.
  # =============================================================================
  vikunja:
    image: vikunja/vikunja:latest
    container_name: vikunja
    user: "0:0"
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${VIKUNJA_PORT:-3456}:3456"
    environment:
      VIKUNJA_SERVICE_JWTSECRET: ${VIKUNJA_JWT_SECRET:-vikunja-jwt-secret-change-me}
      VIKUNJA_SERVICE_PUBLICURL: "https://vikunja.${BASE_DOMAIN}"
      VIKUNJA_SERVICE_FRONTENDURL: "https://vikunja.${BASE_DOMAIN}"
      VIKUNJA_CORS_ENABLE: "false"
      VIKUNJA_DATABASE_TYPE: sqlite
      VIKUNJA_DATABASE_PATH: /app/vikunja/vikunja.db
    volumes:
      - type: volume
        source: vikunja-data
        target: /app/vikunja
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${VIKUNJA_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=vikunja
      - glance.name=Vikunja
      - glance.icon=si:vikunja
      - glance.url=/go/vikunja
      - glance.description=Task Management
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.vikunja.rule=Host(`vikunja.${BASE_DOMAIN}`)
      - traefik.http.routers.vikunja.entrypoints=websecure
      - traefik.http.routers.vikunja.tls=true
      - traefik.http.services.vikunja.loadbalancer.server.port=3456
      - traefik.docker.network=shared-network

      - traefik.http.routers.vikunja-http.entrypoints=web
      - traefik.http.routers.vikunja-http.rule=Host(`vikunja.lab`)
      - traefik.http.routers.vikunja-http.service=vikunja

  # =============================================================================
  # IT-TOOLS - Developer Utilities Collection
  # =============================================================================
  # A collection of handy online tools for developers: converters, encoders,
  # formatters, generators, and many more.
  # =============================================================================
  it-tools:
    image: corentinth/it-tools:latest
    container_name: it-tools
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${IT_TOOLS_PORT:-8091}:80"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${IT_TOOLS_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=it-tools
      - glance.name=IT-Tools
      - glance.icon=si:docker
      - glance.url=/go/it-tools
      - glance.description=Developer Utilities
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.it-tools.rule=Host(`it-tools.${BASE_DOMAIN}`)
      - traefik.http.routers.it-tools.entrypoints=websecure
      - traefik.http.routers.it-tools.tls=true
      - traefik.http.routers.it-tools.middlewares=it-tools-auth@file
      - traefik.http.services.it-tools.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

      - traefik.http.routers.it-tools-http.entrypoints=web
      - traefik.http.routers.it-tools-http.rule=Host(`it-tools.lab`)
      - traefik.http.routers.it-tools-http.service=it-tools
      - "com.docker.compose.service=it-tools"
      - "description=IT-Tools - Developer Utilities Collection"

  # =============================================================================
  # EXCALIDRAW - Whiteboard Collaboration
  # =============================================================================
  # Virtual whiteboard for sketching hand-drawn like diagrams.
  # =============================================================================
  excalidraw:
    image: excalidraw/excalidraw:latest
    container_name: excalidraw
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${EXCALIDRAW_PORT:-8092}:80"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${EXCALIDRAW_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=excalidraw
      - glance.name=Excalidraw
      - glance.icon=si:excalidraw
      - glance.url=/go/excalidraw
      - glance.description=Whiteboard
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.excalidraw.rule=Host(`excalidraw.${BASE_DOMAIN}`)
      - traefik.http.routers.excalidraw.entrypoints=websecure
      - traefik.http.routers.excalidraw.tls=true
      - traefik.http.routers.excalidraw.middlewares=it-tools-auth@file
      - traefik.http.services.excalidraw.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

      - traefik.http.routers.excalidraw-http.entrypoints=web
      - traefik.http.routers.excalidraw-http.rule=Host(`excalidraw.lab`)
      - traefik.http.routers.excalidraw-http.service=excalidraw
      - "com.docker.compose.service=excalidraw"
      - "description=Excalidraw - Whiteboard Collaboration"

  # =============================================================================
  # DOCMOST - Wiki/Documentation Platform
  # =============================================================================
  # Open-source collaborative wiki and documentation software.
  # =============================================================================
  docmost-db:
    image: postgres:15-alpine
    container_name: docmost-db
    labels:
      - glance.parent=docmost
      - glance.name=Database
    environment:
      POSTGRES_DB: ${DOCMOST_DBNAME:-docmost}
      POSTGRES_USER: ${DOCMOST_DBUSER:-docmost}
      POSTGRES_PASSWORD: ${DOCMOST_DBPASS:-docmost_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - type: volume
        source: docmost-db-data
        target: /var/lib/postgresql/data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DOCMOST_DBUSER:-docmost} -d ${DOCMOST_DBNAME:-docmost}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512m

  docmost-redis:
    image: redis:7-alpine
    container_name: docmost-redis
    labels:
      - glance.parent=docmost
      - glance.name=Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - type: volume
        source: docmost-redis-data
        target: /data
    networks:
      - productivity-network
      - shared-network
    restart: unless-stopped
    profiles:
      - all
      - productivity

  docmost:
    image: docmost/docmost:latest
    container_name: docmost
    depends_on:
      docmost-db:
        condition: service_healthy
      docmost-redis:
        condition: service_healthy
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${DOCMOST_PORT:-8093}:3000"
    environment:
      # Default to local *.lab for LAN HTTP access; override to https://docmost.${BASE_DOMAIN} later.
      APP_URL: ${DOCMOST_APP_URL:-http://docmost.lab}
      APP_SECRET: ${DOCMOST_SECRET:-docmost-secret-key-change-me-2024}
      DATABASE_URL: "postgresql://${DOCMOST_DBUSER:-docmost}:${DOCMOST_DBPASS:-docmost_password_2024}@docmost-db:5432/${DOCMOST_DBNAME:-docmost}"
      REDIS_URL: "redis://docmost-redis:6379"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${DOCMOST_MEMORY_LIMIT:-512m}
    labels:
      # Glance Configuration
      - glance.id=docmost
      - glance.name=Docmost
      - glance.icon=si:readthedocs
      - glance.url=/go/docmost
      - glance.description=Wiki & Documentation
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.docmost.rule=Host(`docmost.${BASE_DOMAIN}`)
      - traefik.http.routers.docmost.entrypoints=websecure
      - traefik.http.routers.docmost.tls=true
      - traefik.http.services.docmost.loadbalancer.server.port=3000
      - traefik.docker.network=shared-network

      - traefik.http.routers.docmost-http.entrypoints=web
      - traefik.http.routers.docmost-http.rule=Host(`docmost.lab`)
      - traefik.http.routers.docmost-http.service=docmost
      - "com.docker.compose.service=docmost"
      - "description=Docmost - Wiki/Documentation Platform"

  # =============================================================================
  # FILE BROWSER - Web file manager (scoped to ./files)
  # =============================================================================
  filebrowser:
    image: filebrowser/filebrowser:s6
    container_name: filebrowser
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${FILEBROWSER_PORT:-8096}:80"
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TIMEZONE:-UTC}
    volumes:
      # Persist File Browser config/DB outside of the browsable root.
      - type: volume
        source: filebrowser-config
        target: /config
      # Only expose the repo ./files directory in the UI.
      - type: bind
        source: ${FILES_BASE_DIR:-./files}
        target: /srv
        bind:
          create_host_path: true
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${FILEBROWSER_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=filebrowser
      - glance.name=File Browser
      - glance.icon=si:docker
      - glance.url=/go/filebrowser
      - glance.description=Web File Manager
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.filebrowser.rule=Host(`filebrowser.${BASE_DOMAIN}`)
      - traefik.http.routers.filebrowser.entrypoints=websecure
      - traefik.http.routers.filebrowser.tls=true
      - traefik.http.services.filebrowser.loadbalancer.server.port=80
      - traefik.docker.network=shared-network

      - traefik.http.routers.filebrowser-http.entrypoints=web
      - traefik.http.routers.filebrowser-http.rule=Host(`filebrowser.lab`)
      - traefik.http.routers.filebrowser-http.service=filebrowser

      - "com.docker.compose.service=filebrowser"
      - "description=File Browser - Web File Manager (scoped to ./files)"

  # =============================================================================
  # HOARDER (KARAKEEP) - Bookmark everything app
  # =============================================================================
  hoarder:
    image: ghcr.io/karakeep-app/karakeep:${HOARDER_VERSION:-release}
    container_name: hoarder
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${HOARDER_PORT:-3030}:3000"
    restart: unless-stopped
    depends_on:
      - hoarder-chrome
      - hoarder-meilisearch
    environment:
      MEILI_ADDR: http://hoarder-meilisearch:7700
      BROWSER_WEB_URL: http://hoarder-chrome:9222
      DATA_DIR: /data
      # Defaults to local *.lab for LAN HTTP access; override later if you expose via HTTPS.
      NEXTAUTH_URL: ${HOARDER_NEXTAUTH_URL:-http://hoarder.lab}
      NEXTAUTH_SECRET: ${HOARDER_NEXTAUTH_SECRET:-hoarder-nextauth-secret-change-me-2024}
      MEILI_MASTER_KEY: ${HOARDER_MEILI_MASTER_KEY:-hoarder-meili-master-key-change-me-2024}
      # Optional: OPENAI_API_KEY for AI tagging
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - type: volume
        source: hoarder-data
        target: /data
    deploy:
      resources:
        limits:
          memory: ${HOARDER_MEMORY_LIMIT:-1g}
    labels:
      # Glance Configuration
      - glance.id=hoarder
      - glance.name=Hoarder
      - glance.icon=si:pocket
      - glance.url=/go/hoarder
      - glance.description=Bookmark Manager
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.hoarder.rule=Host(`hoarder.${BASE_DOMAIN}`)
      - traefik.http.routers.hoarder.entrypoints=websecure
      - traefik.http.routers.hoarder.tls=true

      - traefik.http.routers.hoarder-http.entrypoints=web
      - traefik.http.routers.hoarder-http.rule=Host(`hoarder.lab`)
      - traefik.http.routers.hoarder-http.service=hoarder
      - traefik.http.services.hoarder.loadbalancer.server.port=3000
      - traefik.docker.network=shared-network
      - "com.docker.compose.service=hoarder"
      - "description=Hoarder (Karakeep) - Bookmark Everything"

  hoarder-chrome:
    image: gcr.io/zenika-hub/alpine-chrome:124
    container_name: hoarder-chrome
    labels:
      - glance.parent=hoarder
      - glance.name=Browser
    restart: unless-stopped
    networks:
      - productivity-network
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
    deploy:
      resources:
        limits:
          memory: ${HOARDER_CHROME_MEMORY_LIMIT:-512m}

  hoarder-meilisearch:
    image: getmeili/meilisearch:v1.13.3
    container_name: hoarder-meilisearch
    labels:
      - glance.parent=hoarder
      - glance.name=Search Engine
    restart: unless-stopped
    networks:
      - productivity-network
    environment:
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${HOARDER_MEILI_MASTER_KEY:-hoarder-meili-master-key-change-me-2024}
    volumes:
      - type: volume
        source: hoarder-meilisearch
        target: /meili_data
    deploy:
      resources:
        limits:
          memory: ${HOARDER_MEILI_MEMORY_LIMIT:-1g}

  # =============================================================================
  # BYTESTASH - Code Snippet Manager
  # =============================================================================
  # A self-hosted web application designed to store, organize, and manage code snippets.
  # =============================================================================
  bytestash:
    image: ghcr.io/jordan-dalby/bytestash:latest
    container_name: bytestash
    networks:
      - productivity-network
      - shared-network
    profiles:
      - all
      - productivity
    ports:
      - "${BYTESTASH_PORT:-8094}:5000"
    environment:
      JWT_SECRET: ${BYTESTASH_JWT_SECRET:-bytestash-jwt-secret-change-me-2024}
      BASE_PATH: ""
    volumes:
      - type: volume
        source: bytestash-data
        target: /data/snippets
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${BYTESTASH_MEMORY_LIMIT:-256m}
    labels:
      # Glance Configuration
      - glance.id=bytestash
      - glance.name=ByteStash
      - glance.icon=si:github
      - glance.url=/go/bytestash
      - glance.description=Code Snippets
      
      # Traefik Configuration
      - traefik.enable=true
      - traefik.http.routers.bytestash.rule=Host(`bytestash.${BASE_DOMAIN}`)
      - traefik.http.routers.bytestash.entrypoints=websecure
      - traefik.http.routers.bytestash.tls=true
      - traefik.http.services.bytestash.loadbalancer.server.port=5000
      - traefik.docker.network=shared-network

      - traefik.http.routers.bytestash-http.entrypoints=web
      - traefik.http.routers.bytestash-http.rule=Host(`bytestash.lab`)
      - traefik.http.routers.bytestash-http.service=bytestash
      - "com.docker.compose.service=bytestash"
      - "description=ByteStash - Code Snippet Manager"

volumes:
  nocodb-db-data:
  n8n-db-data:
  paperless-db-data:
  paperless-redis-data:
  activepieces-db-data:
  activepieces-redis-data:
  activepieces-data:
  paperless-data:
  postiz-db-data:
  postiz-redis-data:
  focalboard-data:
  trilium-data:
  vikunja-data:
  docmost-db-data:
  docmost-redis-data:
  bytestash-data:
  filebrowser-config:
  hoarder-data:
  hoarder-meilisearch:

